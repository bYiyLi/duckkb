# DuckKB å¹¶å‘å®‰å…¨æ€§åˆ†ææŠ¥å‘Š

## ä¸€ã€é—®é¢˜æ¦‚è¿°

åˆ†æ DuckKB çŸ¥è¯†åº“åœ¨ä»¥ä¸‹åœºæ™¯çš„å¹¶å‘å®‰å…¨æ€§ï¼š

1. æ•°æ®å¯¼å…¥ä¸æŸ¥è¯¢åŒæ—¶è¿›è¡Œ
2. å¤šä¸ªæŸ¥è¯¢å¹¶å‘æ‰§è¡Œ

## äºŒã€å½“å‰æ¶æ„åˆ†æ

### 2.1 æ•°æ®åº“è¿æ¥ç®¡ç† ([db.py](file:///c:/Users/baiyihuan/code/duckkb/src/duckkb/core/mixins/db.py))

```python
class DBMixin(BaseEngine):
    def __init__(self, *args, **kwargs) -> None:
        self._conn: duckdb.DuckDBPyConnection | None = None

    @property
    def conn(self) -> duckdb.DuckDBPyConnection:
        if self._conn is None:
            self._conn = self._create_connection()  # å•ä¾‹è¿æ¥
        return self._conn
```

**å…³é”®ç‰¹å¾**ï¼š

* ä½¿ç”¨**å•ä¾‹è¿æ¥æ¨¡å¼**ï¼šæ•´ä¸ª Engine å®ä¾‹å…±äº«ä¸€ä¸ªè¿æ¥

* è¿æ¥æ˜¯**æ‡’åŠ è½½**çš„

* ä½¿ç”¨**å†…å­˜æ¨¡å¼** (`duckdb.connect()`)

### 2.2 å¯¼å…¥æ“ä½œå¹¶å‘æ§åˆ¶ ([import\_.py](file:///c:/Users/baiyihuan/code/duckkb/src/duckkb/core/mixins/import_.py))

```python
class ImportMixin(BaseEngine):
    def __init__(self, *args, **kwargs) -> None:
        self._import_lock = asyncio.Lock()  # å¯¼å…¥é”

    async def import_knowledge_bundle(self, temp_file_path: str) -> dict[str, Any]:
        async with self._import_lock:  # ä¿æŠ¤å¯¼å…¥æ“ä½œ
            # ... äº‹åŠ¡å†…æ‰§è¡Œæ‰€æœ‰æ“ä½œ
            self.conn.begin()
            # ... å¯¼å…¥èŠ‚ç‚¹ã€è¾¹ã€æ„å»ºç´¢å¼•
            self.conn.commit()
```

**å…³é”®ç‰¹å¾**ï¼š

* ä½¿ç”¨ `asyncio.Lock()` ä¿æŠ¤å¯¼å…¥æ“ä½œ

* **åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªå¯¼å…¥æ“ä½œ**

* ä½¿ç”¨**äº‹åŠ¡**åŒ…è£…ï¼Œå¤±è´¥ä¼šå›æ»š

### 2.3 æŸ¥è¯¢æ“ä½œ ([search.py](file:///c:/Users/baiyihuan/code/duckkb/src/duckkb/core/mixins/search.py))

```python
async def search(self, query: str, ...) -> list[dict[str, Any]]:
    # ...
    rows = await asyncio.to_thread(self._execute_query, sql, fts_params)
    return self._process_results(rows)

def _execute_query(self, sql: str, params: list[Any] | None = None) -> list[Any]:
    return self.conn.execute(sql, params).fetchall()  # ç›´æ¥ä½¿ç”¨å…±äº«è¿æ¥
```

**å…³é”®ç‰¹å¾**ï¼š

* **æ²¡æœ‰é”ä¿æŠ¤**

* ä½¿ç”¨ `asyncio.to_thread` å°†åŒæ­¥æ•°æ®åº“æ“ä½œæ”¾åˆ°çº¿ç¨‹æ± æ‰§è¡Œ

* ç›´æ¥è®¿é—®å…±äº«çš„ `self.conn`

## ä¸‰ã€æ½œåœ¨å¹¶å‘é—®é¢˜

### é—®é¢˜ 1: DuckDB è¿æ¥çš„çº¿ç¨‹å®‰å…¨æ€§ âš ï¸ **ä¸¥é‡**

**DuckDB Python è¿æ¥å¯¹è±¡ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„**ã€‚æ ¹æ® DuckDB å®˜æ–¹æ–‡æ¡£ï¼š

> A single connection object should not be accessed from multiple threads simultaneously.

å½“å‰ä»£ç çš„é—®é¢˜ï¼š

```
æ—¶é—´çº¿:
T1: æŸ¥è¯¢A é€šè¿‡ asyncio.to_thread åœ¨çº¿ç¨‹æ± çº¿ç¨‹1 æ‰§è¡Œ conn.execute()
T2: æŸ¥è¯¢B é€šè¿‡ asyncio.to_thread åœ¨çº¿ç¨‹æ± çº¿ç¨‹2 æ‰§è¡Œ conn.execute()  â† ç«æ€æ¡ä»¶!
T3: å¯¼å…¥æ“ä½œ é€šè¿‡ asyncio.to_thread åœ¨çº¿ç¨‹æ± çº¿ç¨‹3 æ‰§è¡Œ conn.begin()
```

**åæœ**ï¼š

* æŸ¥è¯¢ç»“æœæ··ä¹±æˆ–ä¸¢å¤±

* è¿æ¥çŠ¶æ€ä¸ä¸€è‡´

* å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒæˆ–æ•°æ®æŸå

### é—®é¢˜ 2: å¯¼å…¥ä¸æŸ¥è¯¢çš„å¹¶å‘ âš ï¸ **ä¸­ç­‰**

å¯¼å…¥é”åªä¿æŠ¤å¯¼å…¥æ“ä½œä¹‹é—´ä¸å†²çªï¼Œä½†**ä¸ä¿æŠ¤å¯¼å…¥ä¸æŸ¥è¯¢ä¹‹é—´**ï¼š

```python
# å¯¼å…¥æ“ä½œæŒæœ‰ _import_lock
async with self._import_lock:
    self.conn.begin()          # å¼€å§‹äº‹åŠ¡
    # å†™å…¥æ•°æ®...
    
    # æ­¤æ—¶æŸ¥è¯¢æ“ä½œå¯èƒ½å¹¶å‘æ‰§è¡Œï¼š
    # æŸ¥è¯¢A: self.conn.execute("SELECT ...")  â† è¯»å–åˆ°äº‹åŠ¡ä¸­é—´çŠ¶æ€?
```

**DuckDB çš„ MVCC ç‰¹æ€§**ï¼š

* DuckDB æ”¯æŒ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰

* è¯»æ“ä½œä¸ä¼šé˜»å¡å†™æ“ä½œ

* ä½†ç”±äº**å…±äº«å•ä¸€è¿æ¥**ï¼ŒMVCC æ— æ³•æ­£å¸¸å·¥ä½œ

### é—®é¢˜ 3: å¤šä¸ªæŸ¥è¯¢å¹¶å‘ âš ï¸ **ä¸¥é‡**

```
æŸ¥è¯¢A: await asyncio.to_thread(lambda: conn.execute(sql1))
æŸ¥è¯¢B: await asyncio.to_thread(lambda: conn.execute(sql2))
æŸ¥è¯¢C: await asyncio.to_thread(lambda: conn.execute(sql3))
```

ä¸‰ä¸ªæŸ¥è¯¢åŒæ—¶æäº¤åˆ°çº¿ç¨‹æ± ï¼Œ**å…±äº«åŒä¸€ä¸ªè¿æ¥å¯¹è±¡**ï¼Œè¿å DuckDB çš„çº¿ç¨‹å®‰å…¨è¦æ±‚ã€‚

## å››ã€ç»“è®º

| åœºæ™¯      | æ˜¯å¦å®‰å…¨  | é£é™©ç­‰çº§    |
| ------- | ----- | ------- |
| å•ä¸ªæŸ¥è¯¢    | âœ… å®‰å…¨  | æ—        |
| å¤šä¸ªæŸ¥è¯¢å¹¶å‘  | âŒ ä¸å®‰å…¨ | ğŸ”´ é«˜    |
| å¯¼å…¥ä¸æŸ¥è¯¢å¹¶å‘ | âŒ ä¸å®‰å…¨ | ğŸ”´ é«˜    |
| å¤šä¸ªå¯¼å…¥å¹¶å‘  | âœ… å®‰å…¨  | æ— ï¼ˆæœ‰é”ä¿æŠ¤ï¼‰ |

**æ ¸å¿ƒé—®é¢˜**ï¼šDuckDB Python è¿æ¥å¯¹è±¡ä¸æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œå½“å‰æ¶æ„ä½¿ç”¨å•ä¸€è¿æ¥ + `asyncio.to_thread` ä¼šå¯¼è‡´ç«æ€æ¡ä»¶ã€‚

## äº”ã€è§£å†³æ–¹æ¡ˆå»ºè®®

### æ–¹æ¡ˆ A: è¿æ¥æ± æ¨¡å¼ï¼ˆæ¨èï¼‰

ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºç‹¬ç«‹çš„è¿æ¥ï¼š

```python
from threading import local

class DBMixin(BaseEngine):
    def __init__(self, *args, **kwargs) -> None:
        self._thread_local = local()
    
    @property
    def conn(self) -> duckdb.DuckDBPyConnection:
        if not hasattr(self._thread_local, 'conn') or self._thread_local.conn is None:
            self._thread_local.conn = self._create_connection()
        return self._thread_local.conn
```

**ä¼˜ç‚¹**ï¼šæ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹è¿æ¥ï¼Œé¿å…ç«æ€æ¡ä»¶
**ç¼ºç‚¹**ï¼šå†…å­˜æ¨¡å¼ä¸‹çš„æ•°æ®ä¸å…±äº«ï¼ˆéœ€è¦æ”¹ç”¨æ–‡ä»¶æ¨¡å¼æˆ–å…¶ä»–æ–¹æ¡ˆï¼‰

### æ–¹æ¡ˆ B: å…¨å±€æ•°æ®åº“é”

ä¸ºæ‰€æœ‰æ•°æ®åº“æ“ä½œæ·»åŠ å…¨å±€é”ï¼š

```python
class DBMixin(BaseEngine):
    def __init__(self, *args, **kwargs) -> None:
        self._db_lock = asyncio.Lock()
    
    async def execute_query(self, sql: str, params=None):
        async with self._db_lock:
            return await asyncio.to_thread(self._execute_query_sync, sql, params)
```

**ä¼˜ç‚¹**ï¼šç®€å•ï¼Œä¸éœ€è¦æ”¹å˜ç°æœ‰æ¶æ„
**ç¼ºç‚¹**ï¼šæ‰€æœ‰æ“ä½œä¸²è¡Œæ‰§è¡Œï¼Œæ€§èƒ½ä¸‹é™

### æ–¹æ¡ˆ C: è¯»å†™åˆ†ç¦» + æ–‡ä»¶æ¨¡å¼

1. ä½¿ç”¨æ–‡ä»¶æ¨¡å¼ DuckDBï¼ˆè€Œéå†…å­˜æ¨¡å¼ï¼‰
2. è¯»æ“ä½œä½¿ç”¨åªè¯»è¿æ¥
3. å†™æ“ä½œä½¿ç”¨ç‹¬å è¿æ¥

**ä¼˜ç‚¹**ï¼šæ”¯æŒçœŸæ­£çš„å¹¶å‘è¯»å†™
**ç¼ºç‚¹**ï¼šéœ€è¦é‡æ„å­˜å‚¨æ¶æ„

### æ–¹æ¡ˆ D: å•çº¿ç¨‹æ‰§è¡Œå™¨

æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½åœ¨å•ä¸€äº‹ä»¶å¾ªç¯çº¿ç¨‹æ‰§è¡Œï¼Œä¸ä½¿ç”¨ `asyncio.to_thread`ï¼š

```python
# ä½¿ç”¨ DuckDB çš„å¼‚æ­¥ APIï¼ˆå¦‚æœæ”¯æŒï¼‰
# æˆ–ä½¿ç”¨ run_in_executor ä½†é™åˆ¶ä¸ºå•çº¿ç¨‹æ‰§è¡Œå™¨
```

**ä¼˜ç‚¹**ï¼šé¿å…å¤šçº¿ç¨‹é—®é¢˜
**ç¼ºç‚¹**ï¼šå¯èƒ½å½±å“å¼‚æ­¥æ€§èƒ½

## å…­ã€æ¨èå®æ–½è·¯å¾„

1. **çŸ­æœŸä¿®å¤**ï¼šé‡‡ç”¨æ–¹æ¡ˆ Bï¼ˆå…¨å±€æ•°æ®åº“é”ï¼‰ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
2. **ä¸­æœŸä¼˜åŒ–**ï¼šè¯„ä¼°æ–¹æ¡ˆ A æˆ– Cï¼Œæ ¹æ®æ€§èƒ½éœ€æ±‚é€‰æ‹©
3. **é•¿æœŸè§„åˆ’**ï¼šè€ƒè™‘å¼•å…¥çœŸæ­£çš„å¼‚æ­¥æ•°æ®åº“é©±åŠ¨æˆ–è¿æ¥æ± 

## ä¸ƒã€æµ‹è¯•å»ºè®®

æ·»åŠ å¹¶å‘æµ‹è¯•ç”¨ä¾‹éªŒè¯ä¿®å¤æ•ˆæœï¼š

```python
async def test_concurrent_queries():
    tasks = [engine.search(f"query_{i}") for i in range(10)]
    results = await asyncio.gather(*tasks)
    # éªŒè¯ç»“æœæ­£ç¡®æ€§

async def test_import_and_query_concurrent():
    import_task = engine.import_knowledge_bundle(temp_file)
    query_tasks = [engine.search(f"query_{i}") for i in range(5)]
    await asyncio.gather(import_task, *query_tasks)
    # éªŒè¯æ•°æ®ä¸€è‡´æ€§
```

