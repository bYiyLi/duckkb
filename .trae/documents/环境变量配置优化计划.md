# 环境变量配置优化计划

## 现状分析

### 当前配置结构

1. **GlobalConfig** ([config.py:30-41](file:///Users/yi/Code/duckkb/src/duckkb/config.py#L30-L41))

   * 定义了 `OPENAI_API_KEY` 和 `OPENAI_BASE_URL`，但默认值为 `None`

   * 没有从环境变量自动读取的逻辑

2. **config.yaml** ([.duckkb/default/config.yaml](file:///Users/yi/Code/duckkb/.duckkb/default/config.yaml))

   * 包含 `embedding`、`log_level`、`global`、`ontology` 等配置

   * 没有 `openai_api_key` 和 `openai_base_url` 配置项

3. **依赖**

   * 项目已依赖 `pydantic-settings>=2.13.1`，但未使用

### 问题

* 环境变量没有自动映射到配置

* 配置文件不支持 OpenAI 相关配置

* 缺少配置优先级机制

## 优化方案

### 1. 改造 GlobalConfig 使用 pydantic-settings

将 `GlobalConfig` 改为继承 `BaseSettings`，实现：

* 自动从环境变量读取 `OPENAI_API_KEY`、`OPENAI_BASE_URL`

* 支持从 `.env` 文件加载

* 环境变量命名保持大写下划线风格（如 `OPENAI_API_KEY`）

```python
from pydantic_settings import BaseSettings, SettingsConfigDict

class GlobalConfig(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore",
    )
    
    OPENAI_API_KEY: str | None = None
    OPENAI_BASE_URL: str | None = None
```

### 2. 支持从 config.yaml 读取全局配置

在 `KBConfig.from_yaml` 中增加对 `openai_api_key` 和 `openai_base_url` 的读取：

* 配置文件使用小写下划线风格（如 `openai_api_key`）

* 优先级：环境变量 > 配置文件 > 默认值

### 3. 更新配置文件结构

在 `config.yaml` 中增加 `openai` 配置节（可选）：

```yaml
openai:
  api_key: ""    # 可选，优先级低于环境变量
  base_url: ""   # 可选，用于自定义端点
```

## 实施步骤

### 步骤 1：修改 GlobalConfig

* 文件：`src/duckkb/config.py`

* 改为继承 `pydantic_settings.BaseSettings`

* 添加 `model_config` 配置

### 步骤 2：修改 KBConfig 加载逻辑

* 文件：`src/duckkb/config.py`

* 在 `KBConfig.from_yaml` 中读取 `openai` 配置节

* 合并环境变量和配置文件的值（环境变量优先）

### 步骤 3：更新 AppContext 初始化

* 文件：`src/duckkb/config.py`

* 确保 `GlobalConfig` 正确初始化并合并配置文件值

### 步骤 4：更新测试

* 文件：`tests/test_config.py`

* 添加环境变量读取测试

* 添加配置优先级测试

### 步骤 5：更新示例配置文件

* 文件：`.duckkb/default/config.yaml`

* 添加 `openai` 配置节（带注释说明）

## 配置优先级

最终配置值的优先级（从高到低）：

1. 环境变量 (`OPENAI_API_KEY`, `OPENAI_BASE_URL`)
2. `.env` 文件
3. `config.yaml` 中的 `openai.api_key` / `openai.base_url`
4. 默认值 (`None`)

## 变更文件清单

| 文件                            | 操作 |
| ----------------------------- | -- |
| `src/duckkb/config.py`        | 修改 |
| `tests/test_config.py`        | 修改 |
| `.duckkb/default/config.yaml` | 修改 |

