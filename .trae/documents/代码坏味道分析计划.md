# DuckKB ä»£ç åå‘³é“åˆ†æè®¡åˆ’

## åˆ†æèŒƒå›´

å¯¹ DuckKB é¡¹ç›® `src/duckkb/` ç›®å½•ä¸‹çš„æ‰€æœ‰ Python æºä»£ç è¿›è¡Œå…¨é¢å®¡æŸ¥ï¼Œè¯†åˆ«ä»£ç åå‘³é“ï¼ˆCode Smellsï¼‰ã€‚

---

## ä¸€ã€å·²ä¿®å¤çš„å†å²é—®é¢˜ âœ…

å¯¹æ¯”ä¹‹å‰çš„åˆ†ææŠ¥å‘Šï¼Œä»¥ä¸‹é—®é¢˜å·²å¾—åˆ°è§£å†³ï¼š

| é—®é¢˜ | åŸä½ç½® | å½“å‰çŠ¶æ€ |
|------|--------|----------|
| ç‰ˆæœ¬å·ç¡¬ç¼–ç  | `main.py` | âœ… å·²æ”¹ç”¨ `__version__` ä» `importlib.metadata` åŠ¨æ€è·å– |
| æ¨¡å—èŒè´£æ··ä¹± | `indexer.py` | âœ… å·²æ‹†åˆ†ä¸º `sync.py`, `importer.py`, `cache.py` |
| å“ˆå¸Œè®¡ç®—é‡å¤ | å¤šå¤„ | âœ… å·²æå–ä¸º `text.compute_text_hash()` |
| é­”æ³•å€¼æ•£è½ | å¤šå¤„ | âœ… å¤§éƒ¨åˆ†å·²æå–åˆ° `constants.py` |

---

## äºŒã€å½“å‰å­˜åœ¨çš„ä»£ç åå‘³é“

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### 1. è¿åé¡¹ç›®è§„èŒƒï¼šä½¿ç”¨ `print()` è€Œé `logging`

**ä½ç½®**: [main.py:60](file:///Users/yi/Code/duckkb/src/duckkb/main.py#L60)

```python
def version():
    """æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ã€‚"""
    print(f"DuckKB v{__version__}")  # è¿åé¡¹ç›®è§„åˆ™
```

**é—®é¢˜**: é¡¹ç›®è§„èŒƒæ˜ç¡®è¦æ±‚"æ—¥å¿—åªç”¨ loggingï¼›ç¦æ­¢ print"ã€‚

**å»ºè®®**: æ”¹ç”¨ `logger.info()` æˆ–ä½¿ç”¨ `typer.echo()` (CLI è¾“å‡ºä¾‹å¤–æƒ…å†µ)ã€‚

---

#### 2. è£¸å¼‚å¸¸æ•è·ï¼ˆBare Exceptï¼‰

**ä½ç½®**: [importer.py:92-94](file:///Users/yi/Code/duckkb/src/duckkb/engine/importer.py#L92-L94)

```python
try:
    temp_file_path.unlink()
except OSError:
    pass  # é™é»˜å¤„ç†
```

**é—®é¢˜**: è™½ç„¶æŒ‡å®šäº† `OSError`ï¼Œä½†å®Œå…¨é™é»˜å¤„ç†å¯èƒ½éšè—é‡è¦é”™è¯¯ä¿¡æ¯ã€‚

**å»ºè®®**: è‡³å°‘è®°å½• debug çº§åˆ«æ—¥å¿—ã€‚

---

#### 3. SQL æ³¨å…¥é£é™©ï¼šf-string æ‹¼æ¥è¡¨å

**ä½ç½®**: 
- [sync.py:158-159](file:///Users/yi/Code/duckkb/src/duckkb/engine/sync.py#L158-L159)
- [embedding.py:33-34](file:///Users/yi/Code/duckkb/src/duckkb/utils/embedding.py#L33-L34)
- [cache.py:28](file:///Users/yi/Code/duckkb/src/duckkb/engine/cache.py#L28)

```python
# sync.py
conn.execute(f"DELETE FROM {SYS_SEARCH_TABLE} WHERE source_table = ?", [table_name])
conn.executemany(f"INSERT INTO {SYS_SEARCH_TABLE} VALUES (?, ?, ?, ?, ?, ?, ?)", rows)

# embedding.py
query = f"SELECT content_hash, embedding FROM {SYS_CACHE_TABLE} WHERE content_hash IN (...)"

# cache.py
f"DELETE FROM _sys_cache WHERE last_used < current_timestamp - INTERVAL {CACHE_EXPIRE_DAYS} DAY"
```

**é—®é¢˜**: è™½ç„¶è¿™äº›æ˜¯å†…éƒ¨å¸¸é‡ï¼Œä½† f-string æ‹¼æ¥ SQL çš„æ¨¡å¼å®¹æ˜“å¤åˆ¶åˆ°ä¸å®‰å…¨åœºæ™¯ã€‚

**å»ºè®®**: 
- å¯¹äºå¸¸é‡è¡¨åï¼Œå¯ä»¥ä¿æŒç°çŠ¶ä½†æ·»åŠ æ³¨é‡Šè¯´æ˜å®‰å…¨æ€§
- å¯¹äºåŠ¨æ€è¡¨åï¼ˆå¦‚ `table_name` å‚æ•°ï¼‰ï¼Œåº”æ·»åŠ ç™½åå•éªŒè¯

---

#### 4. åŒæ­¥é˜»å¡è°ƒç”¨æ··å…¥å¼‚æ­¥ä»£ç 

**ä½ç½®**: 
- [sync.py:60](file:///Users/yi/Code/duckkb/src/duckkb/engine/sync.py#L60): `state_file.write_bytes(orjson.dumps(sync_state))`
- [schema.py:213](file:///Users/yi/Code/duckkb/src/duckkb/schema.py#L213): `schema_path.read_text(encoding="utf-8")`
- [config.py:123](file:///Users/yi/Code/duckkb/src/duckkb/config.py#L123): `with open(config_path, encoding="utf-8") as f:`

**é—®é¢˜**: é¡¹ç›®è§„èŒƒè¦æ±‚"æ ¸å¿ƒé€»è¾‘å¿…é¡» async/awaitï¼›é˜»å¡ I/O åªèƒ½é€šè¿‡ asyncio.to_thread å°è£…"ï¼Œä½†å¤šå¤„ç›´æ¥ä½¿ç”¨åŒæ­¥ I/Oã€‚

**å»ºè®®**: ä½¿ç”¨ `asyncio.to_thread()` å°è£…è¿™äº›é˜»å¡è°ƒç”¨ã€‚

---

### ğŸŸ  ä¸­ç­‰é—®é¢˜

#### 5. å…¨å±€å¯å˜çŠ¶æ€ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰

**ä½ç½®**: [config.py:146](file:///Users/yi/Code/duckkb/src/duckkb/config.py#L146)

```python
class AppContext:
    _instance: "AppContext | None" = None
    
    @classmethod
    def get(cls) -> "AppContext":
        if cls._instance is None:
            raise RuntimeError("AppContext not initialized...")
        return cls._instance
```

**é—®é¢˜**: 
- æµ‹è¯•æ—¶éœ€è¦æ‰‹åŠ¨ `reset()`ï¼Œå®¹æ˜“é—æ¼
- å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½æœ‰ç«æ€æ¡ä»¶
- éšå¼ä¾èµ–ï¼Œéš¾ä»¥è¿½è¸ª

**å»ºè®®**: è€ƒè™‘ä½¿ç”¨ä¾èµ–æ³¨å…¥æˆ–ä¸Šä¸‹æ–‡å˜é‡ï¼ˆ`contextvars`ï¼‰ã€‚

---

#### 6. å‰¯ä½œç”¨åˆå§‹åŒ–

**ä½ç½®**: [sync.py:28](file:///Users/yi/Code/duckkb/src/duckkb/engine/sync.py#L28)

```python
async def sync_knowledge_base(kb_path: Path):
    segment_text("")  # ä»…ç”¨äºåˆå§‹åŒ– jieba
```

**é—®é¢˜**: è°ƒç”¨ `segment_text("")` ä»…ä¸ºäº†è§¦å‘ jieba åˆå§‹åŒ–ï¼Œè¿™æ˜¯ä¸€ä¸ªéšå¼å‰¯ä½œç”¨ã€‚

**å»ºè®®**: åˆ›å»ºæ˜¾å¼çš„ `init_jieba()` å‡½æ•°å¹¶åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ã€‚

---

#### 7. å¼‚å¸¸å®šä¹‰æœªè¢«ä½¿ç”¨

**ä½ç½®**: [exceptions.py](file:///Users/yi/Code/duckkb/src/duckkb/exceptions.py)

**é—®é¢˜**: å®šä¹‰äº† `DuckKBError`, `ConfigurationError`, `DatabaseError`, `SyncError` ç­‰å¼‚å¸¸ç±»ï¼Œä½†ä»£ç ä¸­å®é™…æŠ›å‡ºçš„æ˜¯ `ValueError`, `RuntimeError`, `OSError` ç­‰æ ‡å‡†å¼‚å¸¸ã€‚

**å»ºè®®**: 
- ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸æ›¿ä»£æ ‡å‡†å¼‚å¸¸
- æˆ–åˆ é™¤æœªä½¿ç”¨çš„å¼‚å¸¸å®šä¹‰

---

#### 8. æ··åˆä½¿ç”¨åŒæ­¥å’Œå¼‚æ­¥æ•°æ®åº“è¿æ¥

**ä½ç½®**: [searcher.py:141](file:///Users/yi/Code/duckkb/src/duckkb/engine/searcher.py#L141)

```python
def _execute_search(sql: str, params: list[Any]) -> list[dict[str, Any]]:
    with get_db(read_only=True) as conn:  # åŒæ­¥è¿æ¥
        ...
```

**é—®é¢˜**: `smart_search()` æ˜¯å¼‚æ­¥å‡½æ•°ï¼Œä½†å†…éƒ¨è°ƒç”¨åŒæ­¥çš„ `_execute_search()`ï¼Œå†é€šè¿‡ `asyncio.to_thread()` åŒ…è£…ã€‚è¿™ç§æ¨¡å¼è™½ç„¶å¯è¡Œï¼Œä½†å¢åŠ äº†å¤æ‚åº¦ã€‚

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨å¼‚æ­¥æ•°æ®åº“è¿æ¥æ¨¡å¼ï¼Œæˆ–æ˜ç¡®æ–‡æ¡£è¯´æ˜è®¾è®¡å†³ç­–ã€‚

---

### ğŸŸ¡ è½»å¾®é—®é¢˜

#### 9. ç±»å‹æ ‡æ³¨ä¸å®Œæ•´

**ä½ç½®**: [searcher.py:139](file:///Users/yi/Code/duckkb/src/duckkb/engine/searcher.py#L139)

```python
def _execute_search(sql: str, params: list[Any]) -> list[dict[str, Any]]:
    # params å®é™…ç±»å‹æ›´å¤æ‚
```

**ä½ç½®**: [sync.py:153](file:///Users/yi/Code/duckkb/src/duckkb/engine/sync.py#L153)

```python
def _bulk_insert(table_name: str, rows: list[tuple[str, str, str, str, str, str, float]]):
    # ç±»å‹æ ‡æ³¨å®Œæ•´ï¼Œä½†å…ƒç»„ç±»å‹è¿‡é•¿
```

**å»ºè®®**: è€ƒè™‘ä½¿ç”¨ `TypeAlias` ç®€åŒ–å¤æ‚ç±»å‹ã€‚

---

#### 10. é…ç½®å¸¸é‡ä½ç½®ä¸å½“

**ä½ç½®**: [config.py:16-22](file:///Users/yi/Code/duckkb/src/duckkb/config.py#L16-L22)

```python
EMBEDDING_MODEL_DIMS: dict[str, int] = {
    "text-embedding-3-small": 1536,
    ...
}

VALID_LOG_LEVELS = {"DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"}
```

**é—®é¢˜**: è¿™äº›å¸¸é‡å®šä¹‰åœ¨ `config.py` è€Œé `constants.py`ã€‚

**å»ºè®®**: ç§»åŠ¨åˆ° `constants.py` ä¿æŒä¸€è‡´æ€§ã€‚

---

#### 11. SQL å­—ç¬¦ä¸²å¯è¯»æ€§å·®

**ä½ç½®**: [searcher.py:52-94](file:///Users/yi/Code/duckkb/src/duckkb/engine/searcher.py#L52-L94)

```python
sql = f"""
WITH {vector_cte},
{text_cte},
combined AS (...)
SELECT ...
"""
```

**é—®é¢˜**: å¤æ‚çš„ SQL æŸ¥è¯¢é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºï¼Œå¯è¯»æ€§å’Œç»´æŠ¤æ€§è¾ƒå·®ã€‚

**å»ºè®®**: 
- å°† SQL æ¨¡æ¿æå–ä¸ºæ¨¡å—çº§å¸¸é‡
- æˆ–ä½¿ç”¨ SQL æ„å»ºå™¨æ¨¡å¼

---

#### 12. æµ‹è¯• fixture çŠ¶æ€ç®¡ç†

**ä½ç½®**: [conftest.py:6-10](file:///Users/yi/Code/duckkb/tests/conftest.py#L6-L10)

```python
@pytest.fixture
def mock_kb_path(tmp_path):
    AppContext.init(tmp_path)
    yield tmp_path
    AppContext.reset()  # éœ€è¦æ‰‹åŠ¨é‡ç½®
```

**é—®é¢˜**: ä¾èµ–æ‰‹åŠ¨ `reset()`ï¼Œå¦‚æœæµ‹è¯•å¼‚å¸¸ä¸­æ–­å¯èƒ½å¯¼è‡´çŠ¶æ€æ³„æ¼ã€‚

**å»ºè®®**: ä½¿ç”¨ `try-finally` æˆ– `contextlib.contextmanager` ç¡®ä¿æ¸…ç†ã€‚

---

#### 13. æ—¥å¿—çº§åˆ«ä¸ä¸€è‡´

**ä½ç½®**: 
- [sync.py:48](file:///Users/yi/Code/duckkb/src/duckkb/engine/sync.py#L48): `logger.debug(f"Skipping {table_name}...")`
- [sync.py:57](file:///Users/yi/Code/duckkb/src/duckkb/engine/sync.py#L57): `logger.error(f"Failed to sync {table_name}: {e}")`

**é—®é¢˜**: åŒæ­¥è·³è¿‡ä½¿ç”¨ `debug`ï¼Œä½†å¤±è´¥ä½¿ç”¨ `error`ï¼Œç¼ºå°‘ä¸­é—´çš„ `warning` æˆ– `info` çº§åˆ«æ—¥å¿—ã€‚

**å»ºè®®**: ç»Ÿä¸€æ—¥å¿—çº§åˆ«ç­–ç•¥ï¼Œå…³é”®æ“ä½œåº”æœ‰ `info` çº§åˆ«æ—¥å¿—ã€‚

---

## ä¸‰ã€ç»Ÿè®¡æ‘˜è¦

| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ | é—®é¢˜ç±»å‹ |
|---------|------|----------|
| ğŸ”´ ä¸¥é‡ | 4 | è§„èŒƒè¿åã€å®‰å…¨é£é™©ã€é˜»å¡ I/O |
| ğŸŸ  ä¸­ç­‰ | 4 | æ¶æ„è®¾è®¡ã€ä»£ç ç»„ç»‡ |
| ğŸŸ¡ è½»å¾® | 5 | ä»£ç é£æ ¼ã€å¯ç»´æŠ¤æ€§ |
| **æ€»è®¡** | **13** | |

---

## å››ã€å»ºè®®ä¿®å¤ä¼˜å…ˆçº§

### ç«‹å³ä¿®å¤ï¼ˆP0ï¼‰
1. `main.py` ä¸­çš„ `print()` æ”¹ä¸º `logger` æˆ– `typer.echo()`
2. æ·»åŠ è¡¨åç™½åå•éªŒè¯é˜²æ­¢æ½œåœ¨ SQL æ³¨å…¥

### çŸ­æœŸæ”¹è¿›ï¼ˆP1ï¼‰
3. å°†åŒæ­¥ I/O è°ƒç”¨æ”¹ä¸º `asyncio.to_thread()` å°è£…
4. ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸æ›¿ä»£æ ‡å‡†å¼‚å¸¸
5. æ”¹è¿›æµ‹è¯• fixture çš„çŠ¶æ€ç®¡ç†

### é•¿æœŸé‡æ„ï¼ˆP2ï¼‰
6. è€ƒè™‘ä½¿ç”¨ä¾èµ–æ³¨å…¥æ›¿ä»£å…¨å±€å•ä¾‹
7. æå– SQL æ¨¡æ¿ä¸ºå¸¸é‡
8. ç»Ÿä¸€é…ç½®å¸¸é‡ä½ç½®
9. å®Œå–„ç±»å‹æ ‡æ³¨

---

## äº”ã€ä»£ç è´¨é‡äº®ç‚¹ âœ¨

å€¼å¾—è‚¯å®šçš„ä¼˜ç§€å®è·µï¼š

1. **æ¨¡å—åŒ–è®¾è®¡**: å·²å°†åŸ `indexer.py` æ‹†åˆ†ä¸ºèŒè´£å•ä¸€çš„å¤šä¸ªæ¨¡å—
2. **ç±»å‹æ ‡æ³¨**: å¤§éƒ¨åˆ†å…¬å…± API æœ‰å®Œæ•´çš„ç±»å‹æ ‡æ³¨
3. **æ–‡æ¡£æ³¨é‡Š**: ä½¿ç”¨ Google Style docstringï¼Œè¦†ç›–ç‡é«˜
4. **å¸¸é‡æå–**: é­”æ³•å€¼å·²æå–åˆ° `constants.py`
5. **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨ `importlib.metadata` åŠ¨æ€è·å–ç‰ˆæœ¬å·
6. **åŸå­å†™å…¥**: `importer.py` ä½¿ç”¨ staging æ–‡ä»¶å®ç°åŸå­å†™å…¥
7. **å®‰å…¨æ„è¯†**: `query_raw_sql()` æœ‰å®Œå–„çš„ SQL å®‰å…¨æ£€æŸ¥
