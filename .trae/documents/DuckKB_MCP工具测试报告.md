# DuckKB MCP 工具测试报告

**测试日期**: 2026-02-27  
**测试环境**: Windows, DuckKB Demo 知识库  
**测试执行者**: AI Assistant

---

## 一、测试概览

### 测试统计

| 模块 | 测试用例数 | 通过 | 失败 | 通过率 |
|------|-----------|------|------|--------|
| 数据导入功能 | 12 | 10 | 2 | 83.3% |
| 搜索功能 | 12 | 4 | 8 | 33.3% |
| 图遍历功能 | 14 | 10 | 4 | 71.4% |
| 图搜索融合 | 2 | 0 | 2 | 0% |
| SQL 查询功能 | 6 | 3 | 3 | 50% |
| 原始记录获取 | 3 | 1 | 2 | 33.3% |
| 边界条件处理 | 5 | 4 | 1 | 80% |
| **总计** | **54** | **32** | **22** | **59.3%** |

---

## 二、发现的问题清单

### 🔴 严重问题 (5个)

#### 问题 1: 混合搜索返回结果字段映射混乱
- **模块**: 搜索功能
- **描述**: `search` 工具返回的结果中，字段名与实际值完全错乱。`source_table` 显示为数字，`source_id` 显示为表名，`chunk_seq` 显示为字段名，`content` 显示为 0。
- **预期结果**: 
  ```json
  {
    "source_table": "documents",
    "source_id": 6,
    "source_field": "content",
    "chunk_seq": 0,
    "content": "本文档介绍机器学习..."
  }
  ```
- **实际结果**:
  ```json
  {
    "source_table": 45,
    "source_id": "documents",
    "source_field": 6,
    "chunk_seq": "content",
    "content": 0
  }
  ```
- **影响**: 混合搜索功能完全不可用，无法正确解析搜索结果。

---

#### 问题 2: 全文搜索返回空结果
- **模块**: 搜索功能
- **描述**: `fts_search` 工具无论查询什么关键词，都返回空数组 `[]`。
- **测试用例**:
  - 查询 "机器学习" → 返回 `[]`
  - 查询 "测试" → 返回 `[]`
  - 查询 "产品" → 返回 `[]`
- **影响**: 全文搜索功能完全不可用。

---

#### 问题 3: 图搜索融合返回空结果
- **模块**: 图搜索融合
- **描述**: `graph_search` 工具无论查询什么内容，都返回空数组 `[]`。
- **测试用例**:
  - 查询 "机器学习工程师" → 返回 `[]`
  - 指定 node_type 过滤 → 返回 `[]`
- **影响**: 图搜索融合功能完全不可用。

---

#### 问题 4: 原始记录获取 datetime 序列化错误
- **模块**: 原始记录获取
- **描述**: `get_source_record` 工具在获取包含 datetime 字段的记录时，抛出 JSON 序列化错误。
- **错误信息**: `Object of type datetime is not JSON serializable`
- **影响**: 无法获取包含时间戳字段的原始记录。

---

#### 问题 5: SQL 安全限制存在漏洞
- **模块**: SQL 查询功能
- **描述**: SQL 查询工具在处理 UPDATE 和 DELETE 语句时，错误地自动添加了 LIMIT 子句，导致语法错误而非安全拦截。
- **错误信息**: 
  ```
  Parser Error: syntax error at or near "LIMIT"
  LINE 1: UPDATE characters SET age = 100 WHERE name = '测试角色_张三' LIMIT 1000
  ```
- **预期行为**: 应该在 SQL 解析阶段直接拦截危险语句，而非添加 LIMIT 后报语法错误。
- **影响**: 安全机制实现不完善，错误提示不友好。

---

### 🟠 中等问题 (6个)

#### 问题 6: 图遍历返回的邻居节点字段名错误
- **模块**: 图遍历功能
- **描述**: `get_neighbors`、`traverse`、`extract_subgraph`、`find_paths` 等工具返回的邻居节点数据中，字段名显示为 `col_2`, `col_3` 等数字形式，而非正确的字段名。
- **示例**:
  ```json
  {
    "col_2": 13,
    "col_3": "2026-02-27 14:20:14.212705",
    "col_5": "测试角色_李四",
    "col_6": 28
  }
  ```
- **预期结果**: 应该显示 `__id`, `__created_at`, `name`, `age` 等正确字段名。
- **影响**: 图遍历结果难以理解和处理。

---

#### 问题 7: 邻居节点查询返回重复结果
- **模块**: 图遍历功能
- **描述**: 当 `direction="both"` 时，`get_neighbors` 返回重复的邻居节点。同一条边被返回两次（一次作为 out，一次作为 in）。
- **测试用例**: 查询 "测试角色_李四" 的邻居，返回 4 条结果，实际只有 2 个不同的邻居。
- **影响**: 数据冗余，可能误导用户。

---

#### 问题 8: 子图提取边信息不完整
- **模块**: 图遍历功能
- **描述**: `extract_subgraph` 返回的边信息只包含 `__id`, `__from_id`, `__to_id`，缺少边的属性字段（如 `since`, `closeness`, `role` 等）。
- **影响**: 无法获取边的完整信息。

---

#### 问题 9: edge_types 参数格式要求不明确
- **模块**: 图遍历功能
- **描述**: `get_neighbors` 等工具的 `edge_types` 参数在传入 JSON 数组字符串时报错，但不传时正常工作。参数格式要求不清晰。
- **错误信息**: `Input should be a valid list`
- **影响**: API 使用体验差，文档不清晰。

---

#### 问题 10: 负数 limit 参数未提前校验
- **模块**: 边界条件处理
- **描述**: 当 `limit=-1` 时，工具将负数传递到 SQL 层才报错，而非在参数校验阶段拦截。
- **错误信息**: `LIMIT/OFFSET cannot be negative`
- **影响**: 错误处理不够优雅。

---

#### 问题 11: 不存在的表名错误提示不友好
- **模块**: 原始记录获取
- **描述**: 当 `get_source_record` 传入不存在的表名时，错误提示包含无关的 "Did you mean sqlite_temp_master?"。
- **影响**: 错误提示不专业。

---

### 🟡 轻微问题 (2个)

#### 问题 12: 空查询字符串返回空结果
- **模块**: 搜索功能
- **描述**: 空字符串查询返回空数组，无任何提示或错误。
- **建议**: 可以考虑返回错误提示或返回所有数据的摘要。

---

#### 问题 13: limit=0 返回空结果无警告
- **模块**: 边界条件处理
- **描述**: `limit=0` 时静默返回空数组，可能误导用户认为没有数据。
- **建议**: 可以考虑返回警告或拒绝此参数。

---

## 三、功能正常项

### ✅ 数据导入功能
- Character 节点创建 ✓
- Document 节点创建 ✓
- Product 节点创建 ✓
- 节点更新（upsert）✓
- 节点删除 ✓
- 边创建 ✓
- 边更新 ✓
- 必填字段缺失校验 ✓
- 字段类型错误校验 ✓
- 引用不存在节点校验 ✓

### ✅ 向量搜索功能
- 基本向量搜索 ✓
- node_type 过滤 ✓
- 语义相似性搜索 ✓

### ✅ 图遍历功能（部分）
- 邻居节点查询基本功能 ✓
- 多跳遍历基本功能 ✓
- 路径查找基本功能 ✓
- 不存在节点错误处理 ✓

### ✅ SQL 查询功能（部分）
- 基本 SELECT 查询 ✓
- WHERE 条件查询 ✓
- JOIN 查询 ✓
- 聚合查询 ✓
- INSERT 拦截 ✓

---

## 四、改进建议

### 高优先级
1. **修复混合搜索字段映射问题**: 检查 SQL 查询结果到 JSON 的转换逻辑，确保字段名正确映射。
2. **修复全文搜索功能**: 检查全文索引是否正确创建，以及查询语句是否正确执行。
3. **修复图搜索融合功能**: 检查向量搜索与图遍历的融合逻辑。
4. **修复 datetime 序列化问题**: 在返回结果前将 datetime 对象转换为 ISO 格式字符串。

### 中优先级
5. **统一图遍历结果字段名**: 确保所有图遍历工具返回正确的字段名。
6. **优化邻居节点去重**: 当 direction="both" 时，合并重复的邻居节点。
7. **完善边属性返回**: 在子图提取等操作中返回完整的边属性。
8. **改进 SQL 安全机制**: 在 SQL 解析阶段直接拦截危险语句，而非依赖 LIMIT 子句。

### 低优先级
9. **完善参数校验**: 对 limit、max_depth 等参数进行前置校验。
10. **优化错误提示**: 提供更友好、更专业的错误信息。
11. **完善 API 文档**: 明确参数格式要求，特别是数组类型参数。

---

## 五、测试结论

DuckKB MCP 工具的核心数据导入功能基本正常，但搜索功能和图遍历功能存在较多问题。特别是：

1. **混合搜索和全文搜索功能不可用**，严重影响知识库的核心检索能力。
2. **图搜索融合功能不可用**，无法实现语义检索与图谱遍历的结合。
3. **图遍历结果字段名错误**，影响数据的可读性和可用性。
4. **原始记录获取存在序列化问题**，无法正确返回包含时间戳的记录。

建议在发布前优先修复严重问题，确保核心搜索功能正常工作。
