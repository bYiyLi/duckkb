# 知识库查询逻辑分析计划

## 一、已实现功能概览

### 1. SearchMixin - 搜索功能 ✅

| 方法                    | 功能                | 状态    |
| --------------------- | ----------------- | ----- |
| `search()`            | RRF 混合检索（向量 + 全文） | ✅ 已实现 |
| `vector_search()`     | 纯向量语义检索           | ✅ 已实现 |
| `fts_search()`        | 纯全文关键词检索          | ✅ 已实现 |
| `get_source_record()` | 回捞原始业务记录          | ✅ 已实现 |
| `query_raw_sql()`     | 安全执行原始 SQL 查询     | ✅ 已实现 |

### 2. GraphMixin - 知识图谱检索 ✅

| 方法                   | 功能             | 状态    |
| -------------------- | -------------- | ----- |
| `get_neighbors()`    | 获取邻居节点         | ✅ 已实现 |
| `graph_search()`     | 向量检索 + 图遍历融合检索 | ✅ 已实现 |
| `traverse()`         | 多跳图遍历          | ✅ 已实现 |
| `extract_subgraph()` | 提取子图           | ✅ 已实现 |
| `find_paths()`       | 查找两节点间的路径      | ✅ 已实现 |

### 3. IndexMixin - 索引管理 ✅

| 方法                          | 功能             | 状态    |
| --------------------------- | -------------- | ----- |
| `build_index()`             | 构建搜索索引         | ✅ 已实现 |
| `rebuild_index()`           | 重建索引           | ✅ 已实现 |
| `load_cache_from_parquet()` | 从 Parquet 加载缓存 | ✅ 已实现 |
| `save_cache_to_parquet()`   | 保存缓存到 Parquet  | ✅ 已实现 |
| `clean_cache()`             | 清理过期缓存         | ✅ 已实现 |

### 4. EmbeddingMixin - 向量嵌入 ✅

| 方法               | 功能          | 状态    |
| ---------------- | ----------- | ----- |
| `embed()`        | 批量获取向量嵌入    | ✅ 已实现 |
| `embed_single()` | 获取单个文本的向量嵌入 | ✅ 已实现 |

***

## 二、设计文档中规划但未实现的功能

### 1. SearchMixin 扩展功能 ❌

根据 `embedding-and-search-design.md` 设计文档，以下功能未实现：

| 方法                     | 功能             | 设计文档位置      |
| ---------------------- | -------------- | ----------- |
| `smart_search()`       | 智能混合搜索（自动生成嵌入） | 第 357-416 行 |
| `weighted_search()`    | 加权混合搜索（自定义权重）  | 第 417-502 行 |
| `cross_table_search()` | 跨表搜索           | 第 504-549 行 |

**分析**：这些功能在当前实现中已被简化。当前 `search()` 方法已包含自动嵌入生成功能，但 `weighted_search()` 和 `cross_table_search()` 的自定义权重和跨表搜索能力未实现。

### 2. EmbeddingMixin 扩展功能 ❌

| 方法                   | 功能          | 设计文档位置      |
| -------------------- | ----------- | ----------- |
| `embed_node_field()` | 为节点字段生成嵌入向量 | 第 162-219 行 |
| `clean_cache()`      | 清理过期嵌入缓存    | 第 221-239 行 |
| 嵌入缓存机制               | 避免重复 API 调用 | 第 98-148 行  |

**分析**：

* 当前 `EmbeddingMixin.embed()` 直接调用 OpenAI API，**没有实现缓存机制**

* `IndexMixin` 中实现了向量缓存（`_sys_search_cache` 表），但 `EmbeddingMixin` 本身没有独立的缓存层

* 这可能导致重复调用相同文本时产生额外的 API 费用

***

## 三、查询逻辑潜在问题

### 1. SearchMixin 问题

#### 问题 1：`_process_results()` 列名硬编码

**位置**：[search.py:369-386](file:///Users/yi/Code/duckkb/src/duckkb/core/mixins/search.py#L369-L386)

```python
def _process_results(self, rows: list[Any]) -> list[dict[str, Any]]:
    columns = ["source_table", "source_id", "source_field", "chunk_seq", "content", "score"]
    # ...
```

**问题**：列名硬编码，如果 SQL 查询返回的列顺序或数量变化，会导致结果错乱。

**建议**：使用 `cursor.description` 动态获取列名。

#### ~~问题 2：`query_raw_sql()` 安全检查不完整~~

**位置**：[search.py:313-334](file:///Users/yi/Code/duckkb/src/duckkb/core/mixins/search.py#L313-L334)

**说明**：该方法使用只读连接执行 SQL，不存在安全风险，无需额外处理。

#### 问题 3：`_extract_columns_from_sql()` 处理 `SELECT *` 不完整

**位置**：[search.py:400-429](file:///Users/yi/Code/duckkb/src/duckkb/core/mixins/search.py#L400-L429)

**问题**：当 SQL 为 `SELECT *` 时，返回占位列名 `col_0`, `col_1` 等，无法获取实际列名。

**建议**：对于 `SELECT *` 查询，执行后使用 `cursor.description` 获取实际列名。

### 2. GraphMixin 问题

#### 问题 1：`_get_context_recursive()` 节点类型解析错误

**位置**：[graph.py:509](file:///Users/yi/Code/duckkb/src/duckkb/core/mixins/graph.py#L509)

```python
neighbor_type = self._get_node_type_by_table(neighbor.get("edge_type", ""))
```

**问题**：`_get_node_type_by_table()` 需要表名作为参数，但这里传入的是 `edge_type`（边类型名称），导致返回 `None`。

**建议**：应该从邻居节点数据中获取正确的表名或节点类型。

#### 问题 2：`_traverse_nodes_only()` 同样的问题

**位置**：[graph.py:734-737](file:///Users/yi/Code/duckkb/src/duckkb/core/mixins/graph.py#L734-L737)

```python
neighbor_type = self._get_node_type_by_table(
    neighbor.get("edge_type", "")
) or neighbor.get("node_type", node_type)
```

**问题**：同样的错误，使用 `edge_type` 作为表名查询。

### 3. EmbeddingMixin 问题

#### 问题 1：缺少嵌入缓存机制

**位置**：[embedding.py:54-73](file:///Users/yi/Code/duckkb/src/duckkb/core/mixins/embedding.py#L54-L73)

**问题**：`embed()` 方法直接调用 OpenAI API，没有缓存机制。设计文档中规划了 `_sys_embedding_cache` 表来缓存嵌入结果。

**影响**：

* 重复调用相同文本会产生额外 API 费用

* 相同文本的嵌入结果可能不一致（如果模型更新）

**建议**：实现设计文档中的缓存机制，或复用 `IndexMixin` 的缓存表。

### 4. 测试覆盖不足

**位置**：[test\_search.py](file:///Users/yi/Code/duckkb/tests/test_search.py)

**问题**：测试用例较少，没有覆盖：

* 混合检索（`search()`）

* 向量检索（`vector_search()`）

* 全文检索（`fts_search()`）

* 图遍历功能

***

## 四、建议修复优先级

### P0 - 高优先级（影响功能正确性）

1. **修复** **`_get_context_recursive()`** **节点类型解析错误**

   * 影响 `graph_search()` 的上下文获取功能

   * 可能导致返回的邻居节点类型信息不正确

2. **修复** **`_traverse_nodes_only()`** **同样的问题**

   * 影响图遍历功能

### P1 - 中优先级（影响性能）

1. **实现 EmbeddingMixin 缓存机制**
   - 减少 API 调用费用
   - 提高查询性能

### P2 - 低优先级（改进体验）

1. **改进** **`_process_results()`** **动态获取列名**

   * 提高代码健壮性

2. **改进** **`_extract_columns_from_sql()`** **处理** **`SELECT *`**

   * 提高查询结果可读性

3. **补充测试用例**

   * 提高代码质量

***

## 五、未实现功能评估

| 功能                     | 必要性 | 建议                          |
| ---------------------- | --- | --------------------------- |
| `smart_search()`       | 低   | 当前 `search()` 已包含自动嵌入功能     |
| `weighted_search()`    | 中   | 可作为增强功能，支持自定义权重             |
| `cross_table_search()` | 中   | 当前可通过不指定 `node_type` 实现跨表搜索 |
| `embed_node_field()`   | 低   | 当前通过 `build_index()` 实现类似功能 |
| 嵌入缓存机制                 | 高   | 建议实现，减少 API 费用              |

***

## 六、总结

### 查询逻辑整体评估

**优点**：

1. 搜索功能完整，支持向量、全文、混合检索
2. 图遍历功能丰富，支持邻居查询、多跳遍历、路径查找、子图提取
3. 索引管理完善，支持缓存和增量更新
4. MCP 接口层完整暴露所有功能

**问题**：

1. GraphMixin 中存在节点类型解析 bug
2. EmbeddingMixin 缺少缓存机制
3. `query_raw_sql()` 安全检查不完整
4. 测试覆盖不足

**建议**：

1. 优先修复 GraphMixin 中的 bug
2. 实现 EmbeddingMixin 缓存机制
3. 完善 SQL 安全检查
4. 补充测试用例

