# DuckKB 知识库测试计划

## 背景

用户在 `/Users/yi/Code/duckkb/.duckkb/default/config.yaml` 中配置了 Qwen 向量模型：
- 模型：`Qwen/Qwen3-Embedding-8B`
- 维度：4096
- API 端点：`https://api-inference.modelscope.cn/v1`

## 发现的问题

当前代码存在限制，无法直接使用配置的 Qwen 模型：

1. **模型名称验证限制**：[constants.py:17-21](file:///Users/yi/Code/duckkb/src/duckkb/constants.py#L17-L21) 只预定义了 OpenAI 模型
2. **维度验证限制**：[constants.py:32](file:///Users/yi/Code/duckkb/src/duckkb/constants.py#L32) 只允许 1536 或 3072 维度
3. **配置验证器**：[config.py:83-99](file:///Users/yi/Code/duckkb/src/duckkb/config.py#L83-L99) 会拒绝非预定义模型

## 测试计划

### 第一阶段：修改代码支持自定义 Embedding 模型

#### 任务 1.1：放宽模型名称验证
- 修改 `EmbeddingConfig.validate_model()` 方法
- 允许任意模型名称（移除白名单限制）
- 保留模型名称非空检查

#### 任务 1.2：放宽维度验证
- 修改 `EmbeddingConfig.validate_dim()` 方法
- 允许任意正整数维度（移除白名单限制）
- 保留维度必须为正整数的检查

#### 任务 1.3：更新常量定义
- 将 `EMBEDDING_MODEL_DIMS` 改为默认映射（仅用于默认值推断）
- 将 `VALID_EMBEDDING_DIMS` 改为仅用于文档提示

### 第二阶段：测试知识库核心功能

#### 任务 2.1：验证配置加载
- 运行 `duckkb info` 命令验证配置正确加载
- 确认 embedding 模型和维度正确识别

#### 任务 2.2：测试向量嵌入功能
- 创建测试数据并导入
- 验证 embedding API 调用成功
- 检查向量维度是否为 4096

#### 任务 2.3：测试搜索功能
- 测试混合搜索 `duckkb search`
- 测试向量搜索 `duckkb vector-search`
- 测试全文搜索 `duckkb fts-search`

#### 任务 2.4：测试图谱功能
- 测试邻居查询 `duckkb get-neighbors`
- 测试图搜索 `duckkb graph-search`

### 第三阶段：运行单元测试

#### 任务 3.1：运行现有测试
- 执行 `uv run pytest` 确保修改不破坏现有功能
- 修复因验证逻辑变更导致的测试失败

## 验收标准

1. 配置文件中的 Qwen 模型能正确加载
2. 向量嵌入 API 调用成功返回 4096 维向量
3. 搜索功能正常工作
4. 所有单元测试通过

## 风险评估

- **低风险**：修改验证逻辑是向后兼容的，不会影响现有 OpenAI 模型配置
- **需要验证**：Qwen API 的响应格式是否与 OpenAI 兼容（使用 OpenAI SDK 调用）
