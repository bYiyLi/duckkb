# 搜索功能迁移计划

## 背景

将 `smart_search` 历史知识库引擎的搜索功能迁移到新知识库引擎，并通过 MCP 工具暴露。

## 现状分析

### 已有实现

1. **SearchMixin** ([search.py](file:///Users/yi/Code/duckkb/src/duckkb/core/mixins/search.py))
   - `search()` - RRF 混合检索（向量 + 全文）
   - `vector_search()` - 纯向量检索
   - `fts_search()` - 纯全文检索
   - `get_source_record()` - 回捞原始业务记录

2. **Engine** ([engine.py](file:///Users/yi/Code/duckkb/src/duckkb/core/engine.py))
   - 已继承 `SearchMixin`，搜索功能可用

3. **DuckMCP** ([duck_mcp.py](file:///Users/yi/Code/duckkb/src/duckkb/mcp/duck_mcp.py))
   - 继承 `Engine` + `FastMCP`
   - 当前仅注册 2 个工具：`get_knowledge_schema`、`import_knowledge_bundle`

### 旧版实现（已废弃）

- [server.py](file:///Users/yi/Code/duckkb/src/duckkb/mcp/server.py) 中的 `smart_search` 工具
- 使用 `database/engine/search.py` 中的独立函数（非 RRF 算法）

## 迁移方案

### 需要注册的 MCP 工具

| 工具名 | 对应方法 | 功能说明 |
|--------|----------|----------|
| `search` | `Engine.search()` | RRF 混合检索（向量 + 全文） |
| `vector_search` | `Engine.vector_search()` | 纯向量语义检索 |
| `fts_search` | `Engine.fts_search()` | 纯全文关键词检索 |
| `get_source_record` | `Engine.get_source_record()` | 根据搜索结果回捞原始记录 |

### 实现步骤

#### 1. 在 DuckMCP 中注册搜索工具

在 `_register_tools()` 方法中添加新工具注册调用：

```python
def _register_tools(self) -> None:
    self._register_knowledge_schema_tool()
    self._register_import_knowledge_bundle_tool()
    # 新增
    self._register_search_tool()
    self._register_vector_search_tool()
    self._register_fts_search_tool()
    self._register_get_source_record_tool()
```

#### 2. 实现 `_register_search_tool()`

注册 RRF 混合检索工具：

```python
def _register_search_tool(self) -> None:
    @self.tool()
    async def search(
        query: str,
        node_type: str | None = None,
        limit: int = 10,
        alpha: float = 0.5,
    ) -> str:
        """智能混合搜索（RRF 融合）。
        
        结合向量语义检索和全文关键词检索，使用 RRF 算法融合结果。
        
        Args:
            query: 搜索查询文本。
            node_type: 节点类型过滤器（可选）。
            limit: 返回结果数量，默认 10。
            alpha: 向量搜索权重 (0.0-1.0)，默认 0.5。
        
        Returns:
            JSON 格式的搜索结果列表。
        """
        result = await self.search(query, node_type=node_type, limit=limit, alpha=alpha)
        return json.dumps(result, ensure_ascii=False, indent=2)
```

#### 3. 实现 `_register_vector_search_tool()`

注册纯向量检索工具。

#### 4. 实现 `_register_fts_search_tool()`

注册纯全文检索工具。

#### 5. 实现 `_register_get_source_record_tool()`

注册原始记录回捞工具。

## 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `src/duckkb/mcp/duck_mcp.py` | 修改 | 注册 4 个搜索相关 MCP 工具 |

## 验证方式

1. 运行现有测试：`tests/test_searcher.py`
2. 启动 MCP 服务验证工具可用性
3. 测试各搜索功能的正确性

## 风险评估

- **低风险**：SearchMixin 已完整实现且经过测试
- **兼容性**：新工具参数与旧版 `smart_search` 略有不同（`node_type` vs `table_filter`）
