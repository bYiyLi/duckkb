# DuckKB 项目测试执行计划

## 一、项目概况

### 1.1 项目结构
- **源代码目录**: `src/duckkb/`
  - `core/`: 核心引擎与 Mixin 模块
  - `mcp/`: MCP 工具实现
  - `cli/`: 命令行接口
  - `utils/`: 工具类
- **测试目录**: `tests/`
- **测试框架**: pytest + pytest-asyncio + pytest-cov
- **覆盖率要求**: 60% 以上

### 1.2 核心模块
1. **引擎层** (`engine.py`): 异步引擎，组合所有 Mixin
2. **Mixin 层** (`core/mixins/`):
   - `config.py`: 配置加载
   - `db.py`: 数据库连接
   - `ontology.py`: 本体管理
   - `storage.py`: 数据存储
   - `chunking.py`: 文本切片
   - `tokenizer.py`: 分词处理
   - `embedding.py`: 向量嵌入
   - `index.py`: 搜索索引
   - `search.py`: 混合检索
   - `import_.py`: 知识导入
   - `graph.py`: 图遍历
3. **MCP 层** (`mcp/duck_mcp.py`): MCP 工具接口
4. **CLI 层** (`cli/__init__.py`): 命令行工具

## 二、测试文件清单

### 2.1 核心功能测试 (tests/)
| 测试文件 | 测试内容 | 优先级 |
|---------|---------|--------|
| `test_config.py` | 配置加载与验证 | P0 |
| `test_db.py` | 数据库连接与管理 | P0 |
| `test_ontology.py` | 本体定义与 Schema 验证 | P0 |
| `test_storage.py` | 节点/边数据存储 | P0 |
| `test_index.py` | 向量索引与全文索引构建 | P0 |
| `test_search.py` | 混合检索功能 | P0 |
| `test_import.py` | 知识导入流程 | P0 |
| `test_engine.py` | 引擎初始化与生命周期 | P0 |
| `test_graph.py` | 图遍历与路径查询 | P1 |
| `test_embedding.py` | 向量嵌入与缓存 | P1 |
| `test_chunking.py` | 文本切片算法 | P1 |
| `test_tokenizer.py` | 分词器功能 | P1 |
| `test_mcp.py` | MCP 工具接口 | P1 |
| `test_cli.py` | 命令行接口 | P1 |
| `test_concurrency.py` | 并发控制 | P1 |
| `test_duckdb_concurrency.py` | DuckDB 并发查询 | P1 |
| `test_rwlock.py` | 读写锁实现 | P2 |
| `test_error_recovery.py` | 错误处理与恢复 | P1 |
| `test_mcp_parameter_parsing.py` | MCP 参数解析 | P2 |
| `test_real_functional.py` | 端到端功能测试 | P0 |

### 2.2 根目录测试文件 (需整理)
以下测试文件位于根目录，不符合项目规范，需要后续整理到 `tests/` 目录：
- `test_api_models.py`
- `test_check_cache.py`
- `test_check_data.py`
- `test_check_fts_content.py`
- `test_check_fts_content2.py`
- `test_fts_clear_cache.py`
- `test_fts_debug.py`
- `test_fts_fix.py`
- `test_fts_rebuild.py`
- `test_fts_simple.py`
- `test_fts_simple_search.py`

## 三、测试执行策略

### 3.1 测试分类

#### P0 - 核心功能测试 (必须全部通过)
这些测试验证项目最核心的功能，任何失败都会阻塞发布：
```bash
# 运行 P0 测试
pytest tests/test_config.py tests/test_db.py tests/test_ontology.py tests/test_storage.py \
         tests/test_index.py tests/test_search.py tests/test_import.py tests/test_engine.py \
         tests/test_real_functional.py -v
```

#### P1 - 重要功能测试
这些测试验证重要但非阻塞的功能：
```bash
# 运行 P1 测试
pytest tests/test_graph.py tests/test_embedding.py tests/test_chunking.py tests/test_tokenizer.py \
         tests/test_mcp.py tests/test_cli.py tests/test_concurrency.py \
         tests/test_duckdb_concurrency.py tests/test_error_recovery.py -v
```

#### P2 - 辅助功能测试
这些测试验证辅助性功能：
```bash
# 运行 P2 测试
pytest tests/test_rwlock.py tests/test_mcp_parameter_parsing.py -v
```

### 3.2 测试执行顺序

**第一阶段：单元测试** (无状态、快速)
1. `test_config.py` - 配置加载
2. `test_rwlock.py` - 读写锁
3. `test_tokenizer.py` - 分词器
4. `test_chunking.py` - 文本切片

**第二阶段：集成测试** (需要数据库)
5. `test_db.py` - 数据库连接
6. `test_ontology.py` - 本体管理
7. `test_storage.py` - 数据存储
8. `test_embedding.py` - 向量嵌入
9. `test_index.py` - 索引构建

**第三阶段：功能测试** (完整流程)
10. `test_import.py` - 导入流程
11. `test_search.py` - 搜索功能
12. `test_graph.py` - 图遍历
13. `test_engine.py` - 引擎整体

**第四阶段：端到端测试**
14. `test_real_functional.py` - 真实场景
15. `test_mcp.py` - MCP 工具
16. `test_cli.py` - CLI 工具

**第五阶段：专项测试**
17. `test_concurrency.py` - 并发测试
18. `test_duckdb_concurrency.py` - DuckDB 并发
19. `test_error_recovery.py` - 错误恢复
20. `test_mcp_parameter_parsing.py` - 参数解析

## 四、测试验证标准

### 4.1 通过率要求
- **P0 测试**: 100% 通过
- **P1 测试**: 95% 以上通过
- **P2 测试**: 90% 以上通过

### 4.2 覆盖率要求
- **整体覆盖率**: ≥ 60% (由 pytest-cov 强制执行)
- **核心模块覆盖率**: ≥ 80%
  - `core/engine.py`
  - `core/mixins/search.py`
  - `core/mixins/import_.py`
  - `core/mixins/index.py`

### 4.3 性能要求
- 单个测试用例执行时间 < 10 秒
- P0 测试套件总时间 < 2 分钟
- 全部测试套件总时间 < 10 分钟

## 五、测试执行命令

### 5.1 完整测试
```bash
# 运行所有 tests/ 目录下的测试
pytest tests/ -v

# 带覆盖率报告
pytest tests/ -v --cov=duckkb --cov-branch --cov-report=html --cov-report=term-missing

# 并行执行 (使用 pytest-xdist)
pytest tests/ -v -n auto
```

### 5.2 分类测试
```bash
# 按模块测试
pytest tests/test_config.py -v
pytest tests/test_storage.py -v
pytest tests/test_search.py -v

# 按标记测试 (需要添加 pytest.mark)
pytest -m smoke -v
pytest -m integration -v
```

### 5.3 失败调试
```bash
# 失败后进入调试模式
pytest tests/ -x --pdb

# 显示局部变量
pytest tests/ -l

# 停止于第一个失败
pytest tests/ -x
```

## 六、测试环境问题处理

### 6.1 依赖检查
```bash
# 检查依赖是否完整
uv sync --group dev

# 验证 pytest 版本
pytest --version
```

### 6.2 清理测试产物
```bash
# 清理测试生成的临时文件
rm -rf .duckkb/test_*
rm -rf tests/.pytest_cache
rm -rf .coverage coverage.json
```

### 6.3 常见问题
1. **数据库锁定**: 确保测试正确关闭连接
2. **异步测试超时**: 检查是否正确 await
3. **Mock 未生效**: 检查 patch 路径是否正确
4. **覆盖率不达标**: 检查是否有未测试的分支

## 七、测试执行步骤

### 步骤 1: 环境准备
```bash
# 1. 同步依赖
uv sync --group dev

# 2. 清理历史测试产物
rm -rf .coverage coverage.json htmlcov/

# 3. 验证测试环境
pytest --version
```

### 步骤 2: 运行快速测试 (P0)
```bash
# 运行核心功能测试
pytest tests/test_config.py tests/test_db.py tests/test_ontology.py tests/test_storage.py -v
```

### 步骤 3: 运行完整测试
```bash
# 运行所有测试
pytest tests/ -v --tb=short
```

### 步骤 4: 检查覆盖率
```bash
# 生成覆盖率报告
pytest tests/ --cov=duckkb --cov-branch --cov-report=term-missing --cov-report=json
```

### 步骤 5: 修复失败测试
```bash
# 只运行失败的测试
pytest tests/ --last-failed -v

# 重新运行所有测试直到全部通过
pytest tests/ -v --maxfail=5
```

## 八、测试报告输出

### 8.1 测试执行报告
每次测试执行后应记录：
- 总测试用例数
- 通过/失败/跳过数量
- 执行总时间
- 覆盖率统计

### 8.2 失败分析报告
对于失败的测试，应分析：
- 失败原因（断言失败/异常/超时）
- 失败堆栈
- 修复建议

### 8.3 覆盖率分析报告
- 整体覆盖率
- 各模块覆盖率
- 未覆盖的关键代码路径

## 九、后续优化建议

### 9.1 测试文件整理
- 将根目录的 `test_*.py` 文件移动到 `tests/` 目录
- 统一命名规范：`test_<module>.py`

### 9.2 测试标记
为测试用例添加标记便于分类执行：
```python
@pytest.mark.smoke  # 冒烟测试
@pytest.mark.integration  # 集成测试
@pytest.mark.slow  # 慢测试
```

### 9.3 测试优化
- 优化慢测试用例 (< 10 秒)
- 增加参数化测试减少重复代码
- 添加测试覆盖率门槛检查

## 十、验收标准

本次测试任务完成的验收标准：
1. ✅ 所有 P0 测试用例 100% 通过
2. ✅ 整体代码覆盖率 ≥ 60%
3. ✅ 输出完整的测试报告
4. ✅ 记录所有失败用例及修复建议
5. ✅ 验证测试环境配置正确
