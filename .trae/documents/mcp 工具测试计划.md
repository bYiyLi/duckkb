# DuckKB MCP 工具测试计划

## 测试目标

全面测试知识库 MCP 服务器的所有功能，验证各项 API 的正确性、健壮性和边界情况，输出详细的测试报告。

## 测试环境

- 知识库类型：测试知识库（包含 Character、Document、Product 三种节点类型）
- 支持的边类型：knows、authored、mentions
- 测试日期：2026-02-28

## 测试范围

### 1. 数据导入功能 (mcp_duckkb-demo_import)

**测试目的**：验证 YAML 格式数据导入功能

**测试用例**：
1.1. 导入单个 Character 节点
1.2. 导入多个关联节点（Character + Document + Product）
1.3. 导入边关系（knows、authored、mentions）
1.4. 导入不存在的文件路径（错误处理）
1.5. 导入格式错误的 YAML（校验错误处理）
1.6. 删除操作测试（action: delete）

**预期结果**：
- 正常导入返回正确的统计信息（nodes、edges、indexed、dumped）
- 文件不存在时抛出 FileNotFoundError
- 格式错误时抛出 ValueError 并指出精确错误位置

---

### 2. 搜索功能测试

#### 2.1 混合搜索 (mcp_duckkb-demo_search)

**测试目的**：验证 RRF 融合搜索算法

**测试用例**：
2.1.1. 基础搜索查询（默认参数）
2.1.2. 指定 node_type 过滤
2.1.3. 调整 alpha 参数（0.0、0.5、1.0）
2.1.4. 调整 limit 参数
2.1.5. 搜索不存在的关键词

**预期结果**：
- 返回包含 source_table、source_id、content、score 的结果列表
- alpha=0.0 时仅使用全文检索
- alpha=1.0 时仅使用向量检索
- 无结果时返回空列表

#### 2.2 纯向量搜索 (mcp_duckkb-demo_vector_search)

**测试目的**：验证语义检索能力

**测试用例**：
2.2.1. 概念性查询（如"角色关系"）
2.2.2. 指定 node_type 过滤
2.2.3. 调整 limit 参数
2.2.4. 模糊语义匹配测试

**预期结果**：
- 返回语义相关的结果
- 支持模糊匹配，不依赖精确关键词

#### 2.3 纯全文搜索 (mcp_duckkb-demo_fts_search)

**测试目的**：验证关键词匹配能力

**测试用例**：
2.3.1. 精确关键词查询
2.3.2. 指定 node_type 过滤
2.3.3. 调整 limit 参数
2.3.4. 部分匹配测试

**预期结果**：
- 返回包含精确关键词的结果
- 对拼写错误敏感

---

### 3. 原始记录查询 (mcp_duckkb-demo_get_source_record)

**测试目的**：验证从搜索结果回捞原始业务记录

**测试用例**：
3.1. 查询存在的记录（使用搜索结果中的 source_table 和 source_id）
3.2. 查询不存在的记录（返回 null）
3.3. 查询不同节点类型的记录（Character、Document、Product）

**预期结果**：
- 返回完整的业务记录 JSON
- 不存在时返回 null

---

### 4. SQL 查询功能 (mcp_duckkb-demo_query_raw_sql)

**测试目的**：验证只读 SQL 查询功能

**测试用例**：
4.1. 基础 SELECT 查询（查询所有 Character）
4.2. 带 WHERE 条件的查询
4.3. JOIN 查询（跨表连接）
4.4. 聚合查询（COUNT、SUM 等）
4.5. 尝试 INSERT 语句（应被拒绝）
4.6. 尝试 UPDATE 语句（应被拒绝）
4.7. 尝试 DELETE 语句（应被拒绝）
4.8. 超大结果集测试（验证 LIMIT 自动应用）

**预期结果**：
- SELECT 查询正常返回 JSON 结果
- 危险操作（INSERT/UPDATE/DELETE）抛出 ValueError
- 自动应用 LIMIT 限制防止过多数据

---

### 5. 图遍历功能

#### 5.1 获取邻居节点 (mcp_duckkb-demo_get_neighbors)

**测试目的**：查询节点的直接关联节点

**测试用例**：
5.1.1. 获取 Character 的邻居（knows 关系）
5.1.2. 获取 Document 的邻居（authored 关系）
5.1.3. 指定 edge_types 过滤
5.1.4. 指定 direction（out/in/both）
5.1.5. 调整 limit 参数
5.1.6. 查询不存在节点的邻居

**预期结果**：
- 返回包含节点详情和边属性的 JSON
- 支持方向和边类型过滤

#### 5.2 多跳图遍历 (mcp_duckkb-demo_traverse)

**测试目的**：沿指定边类型进行多跳遍历

**测试用例**：
5.2.1. 单跳遍历（max_depth=1）
5.2.2. 多跳遍历（max_depth=2, 3）
5.2.3. 指定 edge_types 过滤
5.2.4. 指定 direction
5.2.5. 关闭路径信息（return_paths=False）
5.2.6. 调整 limit 参数

**预期结果**：
- 返回所有可达节点及路径信息
- 路径信息包含完整的边序列

#### 5.3 查找节点间路径 (mcp_duckkb-demo_find_paths)

**测试目的**：查找两个节点之间的所有路径

**测试用例**：
5.3.1. 查找存在路径的两个节点
5.3.2. 查找无路径的两个节点
5.3.3. 指定 edge_types 过滤
5.3.4. 调整 max_depth 参数
5.3.5. 调整 limit 参数

**预期结果**：
- 返回按路径长度排序的路径列表
- 无路径时返回空列表

---

### 6. 子图提取 (mcp_duckkb-demo_extract_subgraph)

**测试目的**：提取以指定节点为中心的完整子图

**测试用例**：
6.1. 提取单层子图（max_depth=1）
6.2. 提取多层子图（max_depth=2）
6.3. 指定 edge_types 过滤
6.4. 调整 node_limit 和 edge_limit
6.5. 提取不存在节点的子图

**预期结果**：
- 返回包含中心节点、节点列表、边列表的 JSON
- 包含统计信息

---

### 7. 图搜索功能 (mcp_duckkb-demo_graph_search)

**测试目的**：验证向量检索 + 图遍历融合检索

**测试用例**：
7.1. 基础图搜索（默认参数）
7.2. 指定 node_type 过滤种子节点
7.3. 指定 edge_types 过滤遍历
7.4. 调整 traverse_depth
7.5. 调整 search_limit 和 neighbor_limit
7.6. 调整 alpha 参数

**预期结果**：
- 返回种子节点和关联上下文
- 融合语义检索和图遍历结果

---

## 测试执行顺序

1. **准备阶段**：执行数据导入（测试用例 1.1-1.3），建立测试数据集
2. **搜索测试**：执行所有搜索相关测试（测试用例 2.x）
3. **记录查询**：基于搜索结果执行回捞测试（测试用例 3.x）
4. **SQL 查询**：执行各种 SQL 查询测试（测试用例 4.x）
5. **图遍历**：执行图遍历相关测试（测试用例 5.x-7.x）
6. **错误处理**：执行所有错误场景测试

---

## 测试通过标准

- 所有功能测试用例 90% 以上通过
- 错误处理符合预期（抛出正确异常类型）
- 返回数据格式符合 Schema 定义
- 边界情况处理正确

---

## 交付物

1. 测试报告（包含每个测试用例的执行结果）
2. 问题清单（如有问题，包含复现步骤）
3. 功能可用性评估

---

## 风险评估

- **数据依赖**：部分测试依赖前置数据导入，需确保执行顺序
- **状态污染**：测试间可能存在状态影响，需注意清理
- **性能问题**：大图遍历可能耗时较长，需设置合理参数

---

## 备注

- 所有测试使用中文注释和说明
- 记录详细的错误信息和堆栈跟踪
- 对于失败的测试用例，尝试分析原因并提出修复建议
