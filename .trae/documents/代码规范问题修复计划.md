# 代码规范问题修复计划

## 问题概述

通过 `ruff check` 和 `mypy` 检查，发现以下代码规范问题：

### 1. ruff 检查
- ✅ **已通过** - 所有检查通过

### 2. ruff format 检查
- ✅ **已通过** - 27 个文件已格式化

### 3. mypy 类型检查错误（6 个错误）

| 文件 | 行号 | 错误描述 | 问题类型 |
|------|------|----------|----------|
| `ontology.py` | 80 | `"object" has no attribute "items"` | 类型推断问题 |
| `ontology.py` | 227 | `"object" has no attribute "get"` | 类型推断问题 |
| `config.py` | 14 | `Library stubs not installed for "yaml"` | 缺少类型存根 |
| `search.py` | 353 | `Value of type "tuple[Any, ...] | None" is not indexable` | 空值检查问题 |
| `import_.py` | 12 | `Library stubs not installed for "yaml"` | 缺少类型存根 |
| `import_.py` | 162 | `Library stubs not installed for "aiofiles"` | 缺少类型存根 |

---

## 修复方案

### 任务 1: 安装缺失的类型存根包

**问题**: mypy 无法识别 `yaml` 和 `aiofiles` 模块的类型

**解决方案**: 在 `pyproject.toml` 的 dev 依赖中添加：
- `types-PyYAML` - PyYAML 的类型存根
- `types-aiofiles` - aiofiles 的类型存根

**修改文件**: `pyproject.toml`

---

### 任务 2: 修复 ontology.py 类型推断问题

**问题 1 (第 80 行)**:
```python
props = schema.get("properties") or {}
if not isinstance(props, dict):
    _fail(path, "properties must be an object")
for key, prop in props.items():  # mypy 报错：props 类型为 object
```

**解决方案**: 使用 `cast` 进行类型断言
```python
from typing import cast
props = cast("dict[str, object]", schema.get("properties") or {})
```

**问题 2 (第 227 行)**:
```python
props = schema.get("properties") or {}
out: dict[str, object] = {}
for key, value in data.items():
    prop_schema = props.get(key)  # mypy 报错：props 类型为 object
```

**解决方案**: 同样使用 `cast` 进行类型断言

**修改文件**: `src/duckkb/core/models/ontology.py`

---

### 任务 3: 修复 search.py 空值检查问题

**问题 (第 353 行)**:
```python
current_mode = self.conn.execute("SELECT current_setting('access_mode')").fetchone()[0]
```

`fetchone()` 返回 `tuple[Any, ...] | None`，直接索引可能导致 `None[0]` 错误。

**解决方案**: 添加空值检查
```python
result = self.conn.execute("SELECT current_setting('access_mode')").fetchone()
current_mode = result[0] if result else "automatic"
```

**修改文件**: `src/duckkb/core/mixins/search.py`

---

## 执行步骤

1. 修改 `pyproject.toml` 添加类型存根依赖
2. 运行 `uv sync` 安装新依赖
3. 修复 `ontology.py` 的类型断言问题
4. 修复 `search.py` 的空值检查问题
5. 运行 `uv run mypy src/duckkb --ignore-missing-imports` 验证修复
6. 运行 `uv run ruff check src/duckkb` 确保无新增问题
7. 运行 `uv run pytest` 确保测试通过

---

## 验证标准

- [x] `ruff check src/duckkb` 通过
- [x] `ruff format --check src/duckkb` 通过
- [ ] `mypy src/duckkb --ignore-missing-imports` 通过（0 errors）
- [ ] `pytest` 测试通过
