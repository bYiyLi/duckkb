# DuckKB 测试知识库与测试用例编写计划

## 一、任务概述

本计划包含两个主要任务：
1. 在 `.duckkb/default` 创建默认测试知识库，覆盖项目支持的所有特性
2. 创建"测试用例编写技能"，规范测试用例编写要求

## 二、项目支持特性清单

### 2.1 核心功能特性

| 特性类别 | 具体功能 | 测试覆盖要求 |
|---------|---------|-------------|
| **节点类型** | table, identity, schema, vectors | 多种数据类型、必填字段、可选字段 |
| **边类型** | from, to, cardinality, schema | 四种基数（1:1, 1:N, N:1, N:N） |
| **向量嵌入** | 多模型、多维度、多度量 | 1536/3072 维、cosine/l2/inner |
| **文本切片** | 滑动窗口、重叠切片 | 长文本、短文本、边界情况 |
| **中文分词** | jieba 分词、自定义词典 | 中文、中英混合、专业术语 |
| **混合搜索** | RRF 融合向量+全文 | 各种权重配置 |
| **向量搜索** | 纯语义检索 | 相似度排序 |
| **全文搜索** | 关键词匹配 | 分词匹配 |
| **数据导入** | YAML 知识包、upsert/delete | 新增、更新、删除操作 |
| **引用完整性** | 边引用节点检查 | 有效引用、无效引用 |
| **原子持久化** | JSONL/Parquet 存储 | 数据一致性 |
| **SQL 查询** | 只读 SQL、安全限制 | SELECT、LIMIT、安全检查 |

### 2.2 CLI/MCP 命令

| 命令 | 功能 | 测试场景 |
|-----|------|---------|
| `serve` | MCP 服务启动 | 服务初始化 |
| `version` | 版本显示 | 版本输出 |
| `get-knowledge-schema` | 获取 Schema | Schema 结构验证 |
| `import-knowledge-bundle` | 导入知识包 | 正常导入、错误处理 |
| `search` | 混合搜索 | 各种查询场景 |
| `vector-search` | 向量搜索 | 语义匹配 |
| `fts-search` | 全文搜索 | 关键词匹配 |
| `get-source-record` | 回捞原始记录 | 记录存在/不存在 |
| `query-raw-sql` | SQL 查询 | 安全查询、非法查询 |

## 三、测试知识库设计

### 3.1 目录结构

```
.duckkb/default/
├── config.yaml           # 知识库配置
├── user_dict.txt         # 自定义分词词典
└── data/                 # 数据目录
    ├── nodes/
    │   ├── characters/   # 角色节点
    │   │   └── part_0.jsonl
    │   ├── documents/    # 文档节点（长文本）
    │   │   └── part_0.jsonl
    │   └── products/     # 产品节点
    │       └── part_0.jsonl
    ├── edges/
    │   ├── knows/        # 认识关系（N:N）
    │   │   └── part_0.jsonl
    │   ├── authored/     # 作者关系（N:1）
    │   │   └── part_0.jsonl
    │   └── mentions/     # 提及关系（N:N）
    │       └── part_0.jsonl
    └── cache/
        └── search_cache.parquet  # 搜索缓存
```

### 3.2 本体设计（config.yaml）

```yaml
embedding:
  model: text-embedding-3-small
  dim: 1536

log_level: INFO

global:
  chunk_size: 800
  embedding_model: text-embedding-3-small
  tokenizer: jieba

ontology:
  nodes:
    # 角色节点 - 测试基本节点功能
    Character:
      table: characters
      identity: [name]
      schema:
        type: object
        properties:
          name:
            type: string
            description: 角色名称
          age:
            type: integer
            description: 年龄
          email:
            type: string
            format: email
          bio:
            type: string
            description: 角色简介
          status:
            type: string
            enum: [active, inactive, pending]
          tags:
            type: array
            items:
              type: string
          metadata:
            type: object
        required: [name]
      search:
        full_text: [name, bio]
        vectors: [bio]

    # 文档节点 - 测试长文本切片
    Document:
      table: documents
      identity: [doc_id]
      schema:
        type: object
        properties:
          doc_id:
            type: string
          title:
            type: string
          content:
            type: string
            description: 文档内容（长文本）
          category:
            type: string
          word_count:
            type: integer
          created_at:
            type: string
            format: date-time
        required: [doc_id, title]
      search:
        full_text: [title, content]
        vectors: [content]

    # 产品节点 - 测试多字段、数值类型
    Product:
      table: products
      identity: [sku]
      schema:
        type: object
        properties:
          sku:
            type: string
          name:
            type: string
          description:
            type: string
          price:
            type: number
          stock:
            type: integer
          active:
            type: boolean
          rating:
            type: number
          categories:
            type: array
            items:
              type: string
        required: [sku, name]
      search:
        full_text: [name, description]
        vectors: [description]

  edges:
    # 认识关系 - N:N 基数
    knows:
      from: Character
      to: Character
      cardinality: N:N
      schema:
        type: object
        properties:
          since:
            type: string
            format: date
          closeness:
            type: number

    # 作者关系 - N:1 基数
    authored:
      from: Character
      to: Document
      cardinality: N:1
      schema:
        type: object
        properties:
          role:
            type: string
            enum: [author, co-author, editor]

    # 提及关系 - N:N 基数
    mentions:
      from: Document
      to: Product
      cardinality: N:N
      schema:
        type: object
        properties:
          context:
            type: string
          relevance:
            type: number

usage_instructions: |
  这是一个测试知识库，用于验证 DuckKB 的所有核心功能。
  
  支持的操作：
  - 节点 CRUD：Character, Document, Product
  - 边 CRUD：knows, authored, mentions
  - 搜索：混合搜索、向量搜索、全文搜索
  - SQL 查询：只读 SQL 查询
```

### 3.3 测试数据设计

#### 3.3.1 角色数据（characters）

包含 5-10 个角色，覆盖：
- 中英文名称
- 各种数据类型（string, integer, array, object）
- 不同长度的 bio 字段
- 边界情况（缺失可选字段）

#### 3.3.2 文档数据（documents）

包含 3-5 个文档，覆盖：
- 长文本（超过 chunk_size，测试切片）
- 短文本（小于 chunk_size）
- 中英混合内容
- 日期时间字段

#### 3.3.3 产品数据（products）

包含 5-10 个产品，覆盖：
- 数值类型（price, stock, rating）
- 布尔类型（active）
- 数组类型（categories）
- 中英文描述

#### 3.3.4 边数据

- knows：角色之间的认识关系
- authored：角色与文档的作者关系
- mentions：文档提及产品

### 3.4 自定义词典（user_dict.txt）

```
DuckKB
向量数据库
知识图谱
语义检索
全文检索
混合搜索
RRF
嵌入向量
```

## 四、测试用例编写技能

### 4.1 技能文件位置

```
.trae/skills/test-case-writing.md
```

### 4.2 技能内容框架

```markdown
# 测试用例编写技能

## 核心原则

1. **真实数据优先**：所有测试用例必须使用真实数据进行测试
2. **Mock 限制**：仅向量/大模型调用可使用 mock，其他任何组件禁止 mock
3. **覆盖率目标**：项目代码覆盖率 80% 以上

## 测试数据规范

### 真实数据要求
- 使用有意义的中文/英文数据
- 数据应反映真实业务场景
- 避免使用 "test", "foo", "bar" 等无意义数据

### Mock 规则
- ✅ 允许：OpenAI Embedding API 调用
- ✅ 允许：大模型 API 调用
- ❌ 禁止：数据库操作 mock
- ❌ 禁止：文件系统操作 mock
- ❌ 禁止：分词器 mock
- ❌ 禁止：配置加载 mock

## 测试场景覆盖

### 功能测试
- 正常流程测试
- 边界条件测试
- 异常处理测试
- 并发安全测试

### 数据类型测试
- 字符串类型
- 整数类型
- 浮点数类型
- 布尔类型
- 数组类型
- 对象类型
- 日期时间类型
- 空值处理

### 搜索测试
- 精确匹配
- 模糊匹配
- 语义相似
- 混合检索
- 空查询
- 特殊字符

## 测试文件组织

tests/
├── conftest.py          # 共享 fixtures
├── test_config.py       # 配置测试
├── test_ontology.py     # 本体测试
├── test_engine.py       # 引擎测试
├── test_storage.py      # 存储测试
├── test_import.py       # 导入测试
├── test_search.py       # 搜索测试
├── test_chunking.py     # 切片测试
├── test_tokenizer.py    # 分词测试
├── test_embedding.py    # 向量测试
├── test_cli.py          # CLI 测试
└── test_mcp.py          # MCP 测试
```

## 五、测试用例详细设计

### 5.1 配置测试（test_config.py）

- [ ] 默认配置加载
- [ ] YAML 配置加载
- [ ] 配置验证（无效模型、无效维度、无效日志级别）
- [ ] 本体配置加载
- [ ] AppContext 单例测试

### 5.2 本体测试（test_ontology.py）

- [ ] 节点类型验证
- [ ] 边类型验证
- [ ] 边引用节点验证
- [ ] Schema 结构验证
- [ ] DDL 生成测试

### 5.3 引擎测试（test_engine.py）

- [ ] 引擎初始化
- [ ] 异步初始化
- [ ] 数据加载
- [ ] 上下文管理器

### 5.4 存储测试（test_storage.py）

- [ ] 节点加载/导出
- [ ] 边加载/导出
- [ ] 缓存加载/导出
- [ ] 确定性 ID 计算

### 5.5 导入测试（test_import.py）

- [ ] 节点 upsert
- [ ] 节点 delete
- [ ] 边 upsert
- [ ] 边 delete
- [ ] 引用完整性检查
- [ ] Schema 校验
- [ ] 事务回滚
- [ ] 原子替换

### 5.6 搜索测试（test_search.py）

- [ ] 混合搜索
- [ ] 向量搜索
- [ ] 全文搜索
- [ ] 节点类型过滤
- [ ] 结果限制
- [ ] 权重调整
- [ ] 原始记录回捞
- [ ] SQL 查询
- [ ] SQL 安全检查

### 5.7 切片测试（test_chunking.py）

- [ ] 短文本切片
- [ ] 长文本切片
- [ ] 重叠切片
- [ ] 句子边界切片

### 5.8 分词测试（test_tokenizer.py）

- [ ] 中文分词
- [ ] 中英混合分词
- [ ] 自定义词典
- [ ] 批量分词

### 5.9 向量测试（test_embedding.py）

- [ ] 向量生成（mock）
- [ ] 向量缓存
- [ ] 批量向量
- [ ] 哈希计算

### 5.10 CLI 测试（test_cli.py）

- [ ] version 命令
- [ ] get-knowledge-schema 命令
- [ ] import-knowledge-bundle 命令
- [ ] search 命令
- [ ] vector-search 命令
- [ ] fts-search 命令
- [ ] get-source-record 命令
- [ ] query-raw-sql 命令

### 5.11 MCP 测试（test_mcp.py）

- [ ] 工具注册
- [ ] 工具调用
- [ ] 生命周期管理

## 六、实施步骤

### 步骤 1：创建测试知识库目录结构
- 创建 `.duckkb/default/` 目录
- 创建 `data/nodes/`, `data/edges/`, `data/cache/` 子目录

### 步骤 2：创建配置文件
- 编写 `config.yaml`（本体定义）
- 编写 `user_dict.txt`（自定义词典）

### 步骤 3：创建测试数据
- 编写 `characters/part_0.jsonl`
- 编写 `documents/part_0.jsonl`
- 编写 `products/part_0.jsonl`
- 编写 `knows/part_0.jsonl`
- 编写 `authored/part_0.jsonl`
- 编写 `mentions/part_0.jsonl`

### 步骤 4：创建测试用例编写技能
- 创建 `.trae/skills/test-case-writing.md`

### 步骤 5：编写测试用例
- 更新 `tests/conftest.py`（共享 fixtures）
- 编写各模块测试文件

### 步骤 6：运行测试并验证覆盖率
- 运行 `pytest --cov`
- 确保覆盖率 80% 以上

## 七、验收标准

1. ✅ 测试知识库覆盖所有支持的特性
2. ✅ 测试数据使用真实数据
3. ✅ 测试用例编写技能文档完整
4. ✅ 所有测试用例通过
5. ✅ 代码覆盖率 80% 以上
6. ✅ 向量/大模型调用使用 mock，其他组件不使用 mock
