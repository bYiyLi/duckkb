# 配置文件优化计划

## 现状分析

### 当前配置结构

1. **GlobalConfig** ([config.py:30-41](file:///Users/yi/Code/duckkb/src/duckkb/config.py#L30-L41))

   * 定义了 `OPENAI_API_KEY` 和 `OPENAI_BASE_URL`，但默认值为 `None`

   * 没有从配置文件读取的逻辑

2. **config.yaml** ([.duckkb/default/config.yaml](file:///Users/yi/Code/duckkb/.duckkb/default/config.yaml))

   * `embedding` 节包含 `model` 和 `dim`

   * 没有 OpenAI API 配置项

### 问题

* OpenAI API 配置无法通过配置文件设置

* 只能通过代码手动设置 `GlobalConfig` 的值

## 优化方案

### 1. 在 config.yaml 的 embedding 节中增加 api\_key 和 base\_url

```yaml
embedding:
  model: text-embedding-3-small
  dim: 1536
  api_key: ""      # OpenAI API 密钥
  base_url: ""     # 可选，用于自定义 API 端点
```

### 2. 修改 EmbeddingConfig

添加 `api_key` 和 `base_url` 字段：

```python
class EmbeddingConfig(BaseModel):
    model: str = DEFAULT_EMBEDDING_MODEL
    dim: int = DEFAULT_EMBEDDING_DIM
    api_key: str | None = None
    base_url: str | None = None
```

### 3. 修改 KBConfig.from\_yaml

读取 `embedding.api_key` 和 `embedding.base_url`

### 4. 修改 AppContext

从 `kb_config.embedding` 获取 OpenAI 配置初始化 `GlobalConfig`

## 实施步骤

### 步骤 1：修改 EmbeddingConfig

* 文件：`src/duckkb/config.py`

* 添加 `api_key` 和 `base_url` 字段

### 步骤 2：修改 KBConfig.from\_yaml

* 文件：`src/duckkb/config.py`

* 读取 `embedding.api_key` 和 `embedding.base_url`

### 步骤 3：修改 AppContext

* 文件：`src/duckkb/config.py`

* 从 `kb_config.embedding` 获取配置初始化 `GlobalConfig`

### 步骤 4：更新测试

* 文件：`tests/test_config.py`

* 添加 embedding 配置读取 api\_key/base\_url 的测试

### 步骤 5：更新示例配置文件

* 文件：`.duckkb/default/config.yaml`

* 在 `embedding` 节添加 `api_key` 和 `base_url`

## 变更文件清单

| 文件                            | 操作 |
| ----------------------------- | -- |
| `src/duckkb/config.py`        | 修改 |
| `tests/test_config.py`        | 修改 |
| `.duckkb/default/config.yaml` | 修改 |

