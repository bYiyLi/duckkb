# 启动性能优化计划 - 并发数据加载

## 当前状态

经过第一轮优化（批量查询缓存），启动时间从 7 秒减少到 4 秒。

### 当前数据加载流程（串行）

```python
# engine.py:149-172
for node_type in self.ontology.nodes.keys():
    count = await self.load_node(node_type)  # 逐个加载

for edge_name in self.ontology.edges.keys():
    count = await self.load_edge(edge_name)  # 逐个加载
```

### 优化目标

使用 `asyncio.gather()` 并发加载节点和边数据，预期启动时间减少 10-20%。

## 实施方案

### 修改 `_load_existing_data()` 方法

**原代码**：

```python
for node_type in self.ontology.nodes.keys():
    try:
        count = await self.load_node(node_type)
        if count > 0:
            loaded_nodes += count
    except Exception as e:
        # ...

for edge_name in self.ontology.edges.keys():
    try:
        count = await self.load_edge(edge_name)
        if count > 0:
            loaded_edges += count
    except Exception as e:
        # ...
```

**优化后**：

```python
# 并发加载所有节点
async def load_node_safe(node_type: str) -> int:
    try:
        return await self.load_node(node_type)
    except Exception as e:
        error_msg = str(e)
        if "No files found" not in error_msg:
            logger.warning(f"Failed to load node type {node_type}: {e}")
        return 0

node_counts = await asyncio.gather(
    *[load_node_safe(nt) for nt in self.ontology.nodes.keys()]
)
loaded_nodes = sum(node_counts)

# 并发加载所有边
async def load_edge_safe(edge_name: str) -> int:
    try:
        return await self.load_edge(edge_name)
    except Exception as e:
        error_msg = str(e)
        if "No files found" not in error_msg:
            logger.warning(f"Failed to load edge type {edge_name}: {e}")
        return 0

edge_counts = await asyncio.gather(
    *[load_edge_safe(en) for en in self.ontology.edges.keys()]
)
loaded_edges = sum(edge_counts)
```

## 变更文件

* `src/duckkb/core/engine.py`：修改 `_load_existing_data()` 方法

## 验证方法

1. 运行 `uv run duckkb serve` 确认启动正常
2. 比较优化前后的启动时间
3. 确认数据加载正确（节点和边数量正确）

