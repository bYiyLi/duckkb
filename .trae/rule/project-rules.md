---
alwaysApply: true
---

## 技术约束 (Tech Stack)

- **核心架构**：MCP 工具箱 + DuckDB（本地持久化与检索执行引擎）。
- **事实真源**：`data/*.jsonl`（Git 可审计）；`.build/` 仅存运行时产物（可删可重建）。
- **索引体系**：维护 `_sys_search`（全文/混合检索索引）与 `_sys_cache`（embedding 哈希缓存）。
- **分词与检索**：中文分词结果写入 `segmented_text`；检索采用 BM25 + 向量融合，并保留行级 `metadata` 快照。
- **Embedding**：外部 embedding 服务可插拔，但必须走内容哈希缓存，严禁对相同文本重复调用。

## 推荐实现栈 (Python 版)

- **Python 环境与依赖**：优先使用 uv 管理虚拟环境与依赖。
- **CLI（如需要）**：优先使用 Typer（类型友好、适合工具箱风格命令）。
- **MCP 宿主（如采用 Python）**：优先使用 FastMCP。
- **终端输出（如需要）**：优先使用 Rich。
- **重要约束**：严禁引入仓库中未明确存在的第三方依赖；新增依赖必须同步更新文档与工程配置。

## 目录与数据不变量 (Storage Invariants)

- **一库一服**：所有读写必须限制在 `KB_PATH` 指定目录下，禁止跨库读写与路径穿越。
- **文件驱动**：事实变更只能通过修改 `data/*.jsonl` 完成；数据库与索引必须视为派生物。
- **可重建**：删除 `.build/` 后，必须可由 `schema.sql` + `data/*.jsonl` 完整重建。
- **原子写入**：写入 jsonl 必须“写临时文件 → flush/fsync → rename 覆盖”，失败不得污染目标文件。

## 编码规范 (Code Style)

- **类型标注**：公共函数/方法必须有入参与返回值类型；对外工具接口必须定义稳定输入/输出结构。
- **命名规则**：模块/函数 `snake_case`，类 `PascalCase`，常量 `UPPER_SNAKE_CASE`。
- **资源管理**：文件、数据库连接必须显式关闭或使用上下文管理；禁止泄漏句柄。
- **日志与隐私**：禁止输出敏感信息；embedding 相关禁止输出原始全文（最多输出长度与 hash 前缀）。

## MCP 工具接口规范 (MCP Tools)

- **结构化返回**：成功与失败都必须可机读，失败必须包含 `code`、`message`、`details`。
- **错误可修复**：导入校验失败必须定位到行号、字段名、期望类型与实际值，便于 Agent 修复重试。
- **向后兼容**：对外字段变更必须提供兼容策略与迁移路径（至少保证可全量重建）。

## SQL 安全 (SQL Safety)

- **只读执行**：`query_raw_sql` 必须只读；禁止写操作进入该通道。
- **LIMIT 保护**：`SELECT` 若无 `LIMIT`，必须自动追加默认 `LIMIT 1000`。
- **结果大小限制**：返回结果必须受控（目标 2MB 以内）；超出必须截断并返回可解释提示。
- **参数化**：禁止将用户输入拼接进 SQL；结构性输入（表名/字段名）必须白名单映射或 schema 驱动映射。

## 文件与导入 (Import & Atomic IO)

- **jsonl 规则**：每行独立 JSON 对象，合法 JSON，UTF-8，行尾换行。
- **validate_and_import**：先在 `.build/` 做预导入与校验，通过后原子移动到 `data/` 并触发 `sync`。
- **中断安全**：任何阶段失败不得造成 `data/*.jsonl` 半写或损坏；临时文件可安全清理与恢复。

## 性能与成本 (Perf & Cost)

- **Embedding 缓存**：以 `content_hash = Hash(text)` 作为缓存键；命中必须更新 `last_used`；未命中才调用外部服务并回填。
- **缓存 GC**：默认清理 30 天未使用项（参数集中管理，可配置但必须有默认值）。
- **sync 幂等**：重复执行 `sync` 结果必须一致；增量判断必须明确且可测试。

## 测试与质量门禁 (Quality Gate)

- **最小闭环测试**：sync 幂等、原子写入不中毒、只读与 LIMIT 生效、结果大小限制生效、导入错误可定位、缓存命中/未命中行为正确。
- **依赖约束**：严禁引入仓库中未明确存在的第三方依赖；新增依赖必须同步更新工程配置与文档。

## 禁止事项 (Never)

- **禁止**绕过 `data/*.jsonl` 直接把事实写入 DuckDB 作为最终态。
- **禁止**在日志/返回值中输出 embedding 原文、密钥、token、绝对路径等敏感信息。
- **禁止**无边界读取或返回超大结果集（尤其是无 LIMIT 的查询）。
