name: 1. Publish on Tag

# è§¦å‘å™¨ï¼šåªåœ¨ v* æ ‡ç­¾è¢«æ¨é€æ—¶è¿è¡Œ
on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-publish-release:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code (Full History)
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è®¾ç½®ä¸º 0 (full clone)
          # ä½ çš„ Makefile build éœ€è¦å®Œæ•´çš„ git å†å²æ¥æ‰¾åˆ° tag
          fetch-depth: 0

      - name: 2. Publish Release Package
        uses: docker://ghcr.io/astral-sh/uv:python3.12-bookworm
        env:
          UV_PUBLISH_USERNAME: ${{ secrets.UV_PUBLISH_USERNAME }}
          UV_PUBLISH_PASSWORD: ${{ secrets.UV_PUBLISH_PASSWORD }}
        with:
          entrypoint: make
          args: publish-ci
      - name: 3. Get Commit Details
        id: commit_details
        run: |
          OUTPUT_FILE=${GITEA_OUTPUT:-$GITHUB_OUTPUT}
          
          # ä½¿ç”¨ git log å’Œ git rev-parse æ¥è·å–ä¿¡æ¯
          # %an = ä½œè€…åå­—
          # %s  = Commit æ¶ˆæ¯ (ä»…æ ‡é¢˜è¡Œ)
          # %h  = çŸ­ SHA
          
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=%an)" >> $OUTPUT_FILE
          echo "COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)" >> $OUTPUT_FILE
          echo "COMMIT_MSG=$(git log -1 --pretty=%s)" >> $OUTPUT_FILE

      - name: 4. Send Matrix Notification
        uses: s3krit/matrix-message-action@v0.0.3
        with:
          room_id: ${{ secrets.MATRIX_ROOM_ID }}
          access_token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          server: ${{ secrets.MATRIX_HOMESERVER }}

          # åªèƒ½ä½¿ç”¨ message å­—æ®µï¼Œæ‰€æœ‰å†…å®¹éƒ½æ˜¯çº¯æ–‡æœ¬
          # æˆ‘ä»¬ç”¨ "---" ä½œä¸ºåˆ†éš”ç¬¦æ¥æ’ç‰ˆ
          message: |
            <p>
              <h3>ğŸš€ [${{ gitea.repository }}] ç‰ˆæœ¬ ${{ github.ref_name }} å‘å¸ƒæˆåŠŸ!</h3>
            </p>
            <p>
              <strong>ä½œè€…:</strong> &nbsp; ${{ steps.commit_details.outputs.COMMIT_AUTHOR }}<br>
              <strong>Commit:</strong> <code>${{ steps.commit_details.outputs.COMMIT_SHA_SHORT }}</code><br>
              <strong>æ¶ˆæ¯:</strong> &nbsp; ${{ steps.commit_details.outputs.COMMIT_MSG }}
            </p>
            <p>
              <a href="https://gitea.y2l.top/${{ gitea.repository }}/actions/runs/${{ gitea.run_number }}">ğŸ‘‰ æŸ¥çœ‹å·¥ä½œæµ #${{ gitea.run_number }}</a><br>
              <a href="https://gitea.y2l.top/${{ gitea.repository }}/commit/${{ gitea.sha }}">ğŸ‘‰ æŸ¥çœ‹ Commit è¯¦æƒ…</a>
            </p>
            
      - name: 5. Send Matrix Notification (Failure)
        if: failure()
        uses: s3krit/matrix-message-action@v0.0.3
        with:
          room_id: ${{ secrets.MATRIX_ROOM_ID }}
          access_token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          server: ${{ secrets.MATRIX_HOMESERVER }}
          message: |
            <p>
              <h3>âŒ [${{ gitea.repository }}] ç‰ˆæœ¬ ${{ github.ref_name }} å‘å¸ƒå¤±è´¥!</h3>
            </p>
            <p>
              <strong>ä½œè€…:</strong> &nbsp; ${{ steps.commit_details.outputs.COMMIT_AUTHOR }}<br>
              <strong>Commit:</strong> <code>${{ steps.commit_details.outputs.COMMIT_SHA_SHORT }}</code>
            </p>
            <p>
              <a href="https://gitea.y2l.top/${{ gitea.repository }}/actions/runs/${{ gitea.run_number }}">ğŸ”¥ æŸ¥çœ‹å¤±è´¥è¯¦æƒ… #${{ gitea.run_number }}</a>
            </p>